<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Admin Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Poppins', sans-serif; color: #4b5563; }
        .sidebar { position: fixed; height: 100vh; width: 260px; background: #fff; border-right: 1px solid #e5e7eb; padding-top: 30px; z-index: 1000; }
        .sidebar h3 { color: #8b5cf6; text-align: center; font-weight: 700; margin-bottom: 40px; }
        .nav-link { color: #6b7280; padding: 12px 25px; margin: 4px 15px; border-radius: 12px; transition: 0.3s; font-weight: 500; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background-color: #f5f3ff; color: #7c3aed; }
        .main-content { margin-left: 260px; padding: 40px; }
        .card { border: none; background: #fff; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        .btn-primary { background: #8b5cf6; border: none; } .btn-primary:hover { background: #7c3aed; }
        
        /* QR Card Styles */
        .qr-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; text-align: center; background: #fff; }
        .qr-card img { margin: 0 auto; display: block; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>‚öúÔ∏è SCOUT<span style="color:#222">SYS</span></h3>
    <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" onclick="loadView('dashboard', this)"><i class="bi bi-grid-fill"></i> Overview</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadView('directory', this)"><i class="bi bi-folder2-open"></i> Directory</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadView('events', this)"><i class="bi bi-calendar4-event"></i> Events</a></li>
        <li class="nav-item" id="nav-staff"><a class="nav-link" onclick="loadView('staff', this)"><i class="bi bi-people-fill"></i> Staff</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadView('registration', this)"><i class="bi bi-person-vcard-fill"></i> Registration</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadView('reports', this)"><i class="bi bi-file-earmark-text-fill"></i> Reports</a></li>
        <li class="nav-item"><a class="nav-link" onclick="loadView('logs', this)"><i class="bi bi-list-task"></i> Logs</a></li>
        <li class="nav-item mt-5"><a class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-left"></i> Logout</a></li>
    </ul>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div><h3 class="fw-bold mb-1" id="pageTitle">Dashboard</h3><span class="badge bg-light text-primary border" id="userRoleDisplay">Loading...</span></div>
        <button onclick="triggerEmergency()" class="btn btn-outline-danger rounded-pill fw-bold" id="btn-emergency"><i class="bi bi-megaphone-fill"></i> Broadcast</button>
    </div>

    <div id="view-dashboard" class="view-section animate__animated animate__fadeIn">
        <div class="row g-4 mb-4">
            <div class="col-md-4"><div class="card p-4"><h6 class="text-muted small fw-bold">TOTAL REGISTERED</h6><h2 class="fw-bold text-dark" id="statTotal">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h6 class="text-muted small fw-bold">TOTAL SCANS</h6><h2 class="fw-bold text-dark" id="statTotalScans">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h6 class="text-muted small fw-bold">SYSTEM</h6><h4 class="fw-bold text-success">Online</h4></div></div>
        </div>
        <h5 class="fw-bold mb-3 text-secondary">Live Event Status</h5>
        <div id="liveEventCards" class="row g-4"><div class="col-12 text-center text-muted py-5">Waiting for scan data...</div></div>
    </div>

    <div id="view-directory" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="card p-4 mb-4">
            <h5 class="fw-bold mb-3">Find Scout</h5>
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Enter ID (e.g. KG25/001) or System Code">
                <button class="btn btn-primary px-4" onclick="performSearch()">SEARCH</button>
            </div>
        </div>
        <div id="scoutGrid" class="row g-3"><div class="col-12 text-center text-muted py-5">Results will appear here...</div></div>
    </div>

    <div id="view-events" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-5">
                <div class="card p-4">
                    <h5 class="fw-bold mb-3">Create Event</h5>
                    <input type="text" id="evtName" class="form-control mb-2" placeholder="Event Name">
                    <select id="evtType" class="form-select mb-2"><option value="ACCESS">Access</option><option value="ACTIVITY">Activity</option><option value="ONE_TIME">One Time</option></select>
                    <input type="text" id="evtActions" class="form-control mb-2" placeholder="Buttons (IN, OUT)">
                    <input type="number" id="evtPoints" class="form-control mb-3" placeholder="Points">
                    <button onclick="saveNewEvent()" class="btn btn-primary w-100">Create</button>
                </div>
            </div>
            <div class="col-md-7"><div class="card p-4"><h5 class="fw-bold mb-3">Active Events</h5><div id="eventsList" class="d-flex flex-column gap-2"></div></div></div>
        </div>
    </div>

    <div id="view-registration" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="card p-4">
            <h5 class="fw-bold mb-3">Bulk Registration</h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">TROOP NO</label>
                    <input type="text" id="troopNumberInput" class="form-control fw-bold" placeholder="e.g. 25">
                </div>
                <div class="col-md-9">
                    <label class="small fw-bold text-muted">DATA (Name, Troop Name, District)</label>
                    <textarea id="bulkInput" class="form-control" rows="3" placeholder="Amal Perera, 25th Kegalle, Kegalle..."></textarea>
                </div>
            </div>
            
            <div id="regProgress" class="progress mb-3" style="display:none; height:5px;"><div class="progress-bar bg-primary" style="width:0%"></div></div>
            <button onclick="processRegistration()" class="btn btn-primary w-100 mb-4">Register & Generate IDs</button>

            <hr>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">Generated IDs (Preview)</h5>
                <button id="btnPrint" onclick="generatePDF()" class="btn btn-dark" disabled>Download PDF</button>
            </div>
            <div id="stickerPreview" class="row g-3 bg-light p-3 rounded" style="min-height: 200px;">
                <div class="col-12 text-center text-muted">No IDs generated yet.</div>
            </div>
        </div>
    </div>

    <div id="view-reports" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="row g-4">
            <div class="col-md-6"><div class="card p-5 text-center h-100"><i class="bi bi-people-fill display-4 text-primary mb-3"></i><h4>Registered Scouts</h4><button onclick="downloadScoutReport()" class="btn btn-outline-primary fw-bold mt-3">Download PDF</button></div></div>
            <div class="col-md-6"><div class="card p-5 text-center h-100"><i class="bi bi-list-columns-reverse display-4 text-success mb-3"></i><h4>Full Event Log</h4><button onclick="downloadLogReport()" class="btn btn-outline-success fw-bold mt-3">Download PDF</button></div></div>
        </div>
    </div>

    <div id="view-staff" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4">
                <div class="card p-4">
                    <h5 class="fw-bold mb-3">Add Staff</h5>
                    <input type="email" id="newEmail" class="form-control mb-2" placeholder="Email">
                    <input type="password" id="newPass" class="form-control mb-2" placeholder="Password">
                    <select id="newRole" class="form-select mb-3"><option value="scanner">Scanner</option><option value="moderator">Moderator</option><option value="admin">Admin</option></select>
                    <button onclick="createNewUser()" class="btn btn-primary w-100">Create</button>
                </div>
            </div>
            <div class="col-md-8"><div class="card p-4"><h5 class="fw-bold mb-3">Team</h5><table class="table"><tbody id="usersTableBody"></tbody></table></div></div>
        </div>
    </div>

    <div id="view-logs" class="view-section animate__animated animate__fadeIn" style="display:none;">
        <div class="card p-4">
            <h5 class="fw-bold mb-4">Live Logs</h5>
            <div class="table-responsive"><table class="table table-hover"><thead class="bg-light"><tr><th class="ps-3">Time</th><th>ID</th><th>Event</th><th>Action</th><th>Scanner</th></tr></thead><tbody id="logsTableBody"></tbody></table></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, onSnapshot, serverTimestamp, getDoc, query, where, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, set, remove, push, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ YOUR CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    let currentUserRole = 'moderator';
    window.recentScouts = []; // To store newly registered scouts

    onAuthStateChanged(auth, async (user) => { 
        if (!user) window.location.href="index.html"; 
        else { 
            const uDoc = await getDoc(doc(db, "users", user.email));
            if(uDoc.exists()) {
                currentUserRole = uDoc.data().role;
                document.getElementById('userRoleDisplay').innerText = currentUserRole.toUpperCase();
                if(currentUserRole === 'moderator') {
                    document.getElementById('nav-staff').style.display = 'none'; 
                    document.getElementById('view-staff').innerHTML = ""; 
                    document.getElementById('btn-emergency').style.display = 'none'; 
                }
            }
            initListeners(); 
        } 
    });

    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

    function initListeners() { 
        loadUsers(); loadEvents(); loadLogs(); loadStats(); listenForEmergencies(); 
    }

    // --- REGISTRATION (FIXED & ROBUST) ---
    window.processRegistration = async function() {
        const troop = document.getElementById('troopNumberInput').value.trim();
        const text = document.getElementById('bulkInput').value.trim();
        
        if(!troop) return Swal.fire('Missing Troop No', 'Please enter the Troop Number (e.g. 25)', 'warning');
        if(!text) return Swal.fire('Empty Data', 'Please paste the scout list.', 'warning');

        const lines = text.split('\n');
        document.getElementById('regProgress').style.display='flex';
        
        // 1. Get Global Counter (Create if not exists)
        let idCounter = 1;
        try {
            const countDoc = await getDoc(doc(db, "system", "scout_counter"));
            if(countDoc.exists()) {
                idCounter = countDoc.data().val + 1;
            } else {
                await setDoc(doc(db, "system", "scout_counter"), { val: 0 });
                idCounter = 1;
            }
        } catch(e) { console.error("Counter Error", e); }

        window.recentScouts = []; // Clear previous batch

        for(let line of lines) {
            let p = line.split(','); 
            if(p.length >= 1 && p[0].trim() !== "") {
                let sID = `KG${troop}/${idCounter.toString().padStart(3, '0')}`; // Display ID
                let docID = `KG${troop}_${idCounter.toString().padStart(3, '0')}`; // Doc ID (No slash)
                
                let scoutData = {
                    name: p[0].trim(),
                    troop: p[1] ? p[1].trim() : `Troop ${troop}`,
                    district: p[2] ? p[2].trim() : "",
                    id: sID, 
                    docId: docID,
                    troopNum: troop,
                    isMissing: false,
                    regDate: serverTimestamp()
                };

                await setDoc(doc(db, "scouts", docID), scoutData);
                window.recentScouts.push(scoutData);
                idCounter++;
            }
        }

        // Update Counter
        await setDoc(doc(db, "system", "scout_counter"), { val: idCounter-1 });
        
        document.getElementById('regProgress').style.display='none'; 
        document.getElementById('btnPrint').disabled = false; 
        
        // üî• Generate Preview & QRs Immediately
        generatePreview();
        
        Swal.fire({icon:'success', title:'Success', text:`Registered ${window.recentScouts.length} Scouts!`});
    }

    // --- QR PREVIEW GENERATION ---
    function generatePreview() {
        const container = document.getElementById('stickerPreview');
        container.innerHTML = "";
        
        window.recentScouts.forEach((s, index) => {
            // Create Card
            let col = document.createElement('div');
            col.className = 'col-md-3 mb-3';
            col.innerHTML = `
                <div class="qr-card">
                    <div id="qr_${index}" class="mb-2"></div>
                    <h6 class="fw-bold mb-0">${s.id}</h6>
                    <small class="text-truncate d-block">${s.name}</small>
                </div>
            `;
            container.appendChild(col);

            // Generate QR into the div immediately
            new QRCode(document.getElementById(`qr_${index}`), {
                text: s.id,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });
    }

    // --- PDF GENERATION (FROM PREVIEW IMAGES) ---
    window.generatePDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let x = 10, y = 10, w = 45, h = 65, col = 0, row = 0;

        window.recentScouts.forEach((s, i) => {
            if(i > 0 && i % 16 === 0) { doc.addPage(); col = 0; row = 0; }
            
            let curX = x + (col * (w + 2));
            let curY = y + (row * (h + 2));

            // Draw Border
            doc.setLineWidth(0.1);
            doc.setLineDash([1, 1], 0);
            doc.rect(curX, curY, w, h);
            doc.setLineDash([]); // Reset

            // Header
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.text("SCOUT PASS", curX + w/2, curY + 6, { align: "center" });

            // Grab QR Image from DOM (Reliable way)
            let qrContainer = document.getElementById(`qr_${i}`);
            let qrImg = qrContainer.querySelector('img');
            
            if (qrImg) {
                doc.addImage(qrImg.src, 'PNG', curX + (w-25)/2, curY + 10, 25, 25);
            }

            // Text Data
            doc.setFontSize(11);
            doc.text(s.id, curX + w/2, curY + 42, { align: "center" });
            
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.text(s.name.substring(0, 18), curX + w/2, curY + 48, { align: "center" });
            
            doc.setFontSize(7);
            doc.text(s.troop.substring(0, 25), curX + w/2, curY + 53, { align: "center" });
            doc.text(s.district.toUpperCase(), curX + w/2, curY + 57, { align: "center" });

            col++;
            if (col >= 4) { col = 0; row++; }
        });

        doc.save(`ScoutIDs_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // --- SEARCH ---
    window.performSearch = async function() {
        const term = document.getElementById('searchInput').value.trim();
        const container = document.getElementById('scoutGrid');
        
        // SYSTEM CLEAR
        if(term === '200431504082') {
            if(currentUserRole !== 'admin') return Swal.fire('Denied', 'Admin Access Only', 'error');
            Swal.fire({title: '‚ö†Ô∏è SYSTEM RESET', text: "WIPE ALL DATA?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'YES'}).then(async (res) => {
                if (res.isConfirmed) {
                    Swal.showLoading();
                    await remove(ref(rtdb, 'logs'));
                    const q = query(collection(db, "scouts"));
                    const snap = await getDocs(q);
                    const batch = writeBatch(db);
                    snap.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await setDoc(doc(db, "system", "scout_counter"), { val: 0 });
                    Swal.fire('System Cleared', '', 'success');
                }
            });
            return;
        }

        if(!term) return Swal.fire('Error', 'Enter ID', 'warning');
        container.innerHTML = `<div class="col-12 text-center text-muted py-5"><span class="spinner-border text-primary"></span></div>`;

        try {
            let results = [];
            let docID = term.replace('/', '_');
            const docRef = doc(db, "scouts", docID);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) results.push({ ...docSnap.data(), _docId: docSnap.id });

            const q1 = query(collection(db, "scouts"), where("id", "==", term));
            const s1 = await getDocs(q1);
            s1.forEach(d => { if(!results.some(r=>r.id===d.data().id)) results.push({ ...d.data(), _docId: d.id }); });

            container.innerHTML = "";
            if(results.length === 0) { container.innerHTML = `<div class="col-12 text-center text-muted">No results.</div>`; return; }

            results.forEach(s => {
                let isMissing = s.isMissing ? "missing-scout" : "";
                let btnMissText = s.isMissing ? "Found?" : "Missing?";
                container.innerHTML += `
                <div class="col-md-4 col-lg-3 animate__animated animate__fadeIn">
                    <div class="card p-3 shadow-sm scout-tile ${isMissing}">
                        <div class="d-flex align-items-center mb-2">
                            <div class="bg-light text-primary d-flex align-items-center justify-content-center me-3" style="width:50px; height:50px; border-radius:50%; font-weight:bold;">${s.name.charAt(0)}</div>
                            <div><h6 class="fw-bold mb-0 text-truncate" style="max-width:150px;">${s.name}</h6><small class="text-muted">${s.id}</small></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-warning w-100" onclick="confirmMissing('${s.docId}', ${s.isMissing})">${btnMissText}</button>
                            <button class="btn btn-sm btn-light-danger" onclick="deleteScout('${s.docId}')"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
        } catch(e) { container.innerHTML = "Error"; }
    }

    // --- ACTIONS ---
    window.confirmMissing = async function(docId, currentStatus) {
        if(await Swal.fire({title: currentStatus?"Mark Found?":"Mark Missing?", icon:'warning', showCancelButton:true}).then(r=>r.isConfirmed)) {
            await updateDoc(doc(db, "scouts", docId), { isMissing: !currentStatus });
            window.performSearch();
        }
    }
    window.deleteScout = async function(id) {
        if(currentUserRole !== 'admin') return Swal.fire('Denied', 'Admin Only', 'error');
        if(await Swal.fire({title: 'Delete?', text:"Cannot undo", icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>r.isConfirmed)) {
            await deleteDoc(doc(db, "scouts", id)); window.performSearch();
        }
    }

    // --- LOGS & STATS ---
    function loadLogs() {
        const logsRef = ref(rtdb, 'logs');
        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            const container = document.getElementById('liveEventCards');
            
            if (data) {
                const logsArr = Object.values(data);
                document.getElementById('statTotalScans').innerText = logsArr.length;

                // Live Cards Logic
                let stats = {};
                logsArr.forEach(l => {
                    if(!stats[l.eventName]) stats[l.eventName] = { in: 0, out: 0 };
                    if(l.action.includes('IN')) stats[l.eventName].in++;
                    if(l.action.includes('OUT')) stats[l.eventName].out++;
                });

                container.innerHTML = "";
                Object.keys(stats).forEach(eventName => {
                    let s = stats[eventName];
                    let current = s.in - s.out; if(current < 0) current = 0;
                    container.innerHTML += `
                    <div class="col-md-3"><div class="card p-3 stat-card"><h6 class="stat-title">${eventName}</h6><div class="d-flex justify-content-between align-items-end mt-2"><div><span class="stat-value text-primary">${current}</span><span class="stat-sub text-muted d-block">Current Inside</span></div><div class="text-end text-muted small"><div class="text-success"><i class="bi bi-arrow-down"></i> ${s.in}</div><div class="text-danger"><i class="bi bi-arrow-up"></i> ${s.out}</div></div></div></div></div>`;
                });

                // Update Table (Last 50)
                const recentLogs = logsArr.reverse().slice(0, 50);
                let h = "";
                recentLogs.forEach(l => {
                    let time = new Date(l.timestamp).toLocaleTimeString();
                    let badgeClass = "badge-other";
                    if(l.action.includes('IN')) badgeClass = "badge-in";
                    if(l.action.includes('OUT')) badgeClass = "badge-out";
                    h += `<tr><td class="ps-3 text-muted small fw-bold">${time}</td><td class="fw-bold">${l.scoutID}</td><td>${l.eventName}</td><td><span class="badge ${badgeClass}">${l.action}</span></td><td class="pe-3 text-secondary small">${l.scannedBy.split('@')[0]}</td></tr>`;
                });
                document.getElementById('logsTableBody').innerHTML = h;

            } else {
                container.innerHTML = `<div class="col-12 text-center text-muted">No activity yet.</div>`;
            }
        });
    }

    // --- REPORTS ---
    window.downloadScoutReport = async function() {
        Swal.showLoading();
        const doc = new window.jspdf.jsPDF();
        const q = query(collection(db, "scouts"));
        const snap = await getDocs(q);
        let data = [];
        snap.forEach(d => { let s=d.data(); data.push([s.id, s.name, s.troop, s.district]); });
        doc.text("Registered Scouts", 14, 15);
        doc.autoTable({head: [['ID', 'Name', 'Troop', 'District']], body: data, startY: 20});
        doc.save("Scouts_Report.pdf");
        Swal.close();
    }

    window.downloadLogReport = function() {
        Swal.showLoading();
        const logsRef = ref(rtdb, 'logs');
        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) { Swal.fire('No Data', '', 'info'); return; }
            const doc = new window.jspdf.jsPDF();
            let rows = [];
            Object.values(data).forEach(l => rows.push([new Date(l.timestamp).toLocaleString(), l.scoutID, l.eventName, l.action, l.scannedBy.split('@')[0]]));
            doc.text("Event Logs", 14, 15);
            doc.autoTable({head: [['Time', 'ID', 'Event', 'Action', 'Scanner']], body: rows, startY: 20});
            doc.save("Logs_Report.pdf");
            Swal.close();
        }, {onlyOnce: true});
    }

    // --- OTHER ---
    function loadStats(){onSnapshot(collection(db,"scouts"),s=>document.getElementById('statTotal').innerText=s.size);}
    window.saveNewEvent=async()=>{const name=document.getElementById('evtName').value;const type=document.getElementById('evtType').value;const actions=document.getElementById('evtActions').value.split(',');const pts=document.getElementById('evtPoints').value;await addDoc(collection(db,"events"),{name,type,actions,points:pts,active:true,createdAt:serverTimestamp()});Swal.fire('Success','Created','success');}
    function loadEvents(){onSnapshot(collection(db,"events"),snap=>{let h="";snap.forEach(d=>{h+=`<div class="card p-3 mb-2 shadow-sm d-flex flex-row justify-content-between"><div><h6 class="fw-bold mb-0">${d.data().name}</h6></div><button class="btn btn-sm btn-light-danger" onclick="deleteEvent('${d.id}')"><i class="bi bi-trash"></i></button></div>`});document.getElementById('eventsList').innerHTML=h;});}
    window.deleteEvent=async(id)=>{if(confirm("Delete?"))await deleteDoc(doc(db,"events",id));}
    window.createNewUser=async()=>{const e=document.getElementById('newEmail').value;const p=document.getElementById('newPass').value;const r=document.getElementById('newRole').value;await createUserWithEmailAndPassword(secondaryAuth,e,p);await setDoc(doc(db,"users",e),{email:e,role:r});await signOut(secondaryAuth);Swal.fire('Success','Created','success');}
    function loadUsers(){onSnapshot(collection(db,"users"),s=>{let h="";s.forEach(d=>{h+=`<tr><td>${d.data().email}</td><td>${d.data().role}</td><td><button class="btn btn-sm btn-light-danger" onclick="deleteUser('${d.id}')">X</button></td></tr>`});document.getElementById('usersTableBody').innerHTML=h;});}
    window.deleteUser=async(id)=>{if(confirm("Remove?"))await deleteDoc(doc(db,"users",id));}
    window.triggerEmergency=async()=>{const{value:t}=await Swal.fire({title:'Broadcast',input:'text'});if(t)await set(ref(rtdb, 'system/broadcast'),{message:t,timestamp:serverTimestamp()});}
    function listenForEmergencies(){onValue(ref(rtdb, 'system/broadcast'),d=>{if(d.exists()&&d.val().message)Swal.fire({icon:'warning',title:'Alert',text:d.val().message})});}
    window.loadView=(v,el)=>{document.querySelectorAll('.view-section').forEach(d=>d.style.display='none');document.getElementById('view-'+v).style.display='block';const t={'dashboard':'Dashboard','events':'Events','staff':'Staff','registration':'Registration','reports':'Reports','directory':'Directory','logs':'Logs'};document.getElementById('pageTitle').innerText=t[v];}
</script>
</body>
</html>
