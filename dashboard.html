<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEBOREE ADMIN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body{background:#f4f6f9;font-family:sans-serif;}
        .sidebar{height:100vh;width:250px;position:fixed;background:#fff;padding-top:20px;border-right:1px solid #ddd;z-index:1000;}
        .main{margin-left:250px;padding:30px;}
        .nav-link{padding:12px 20px;color:#333;cursor:pointer;} .nav-link:hover,.nav-link.active{background:#eef2ff;color:#4f46e5;font-weight:bold;}
        .card{border:none;border-radius:15px;box-shadow:0 2px 10px rgba(0,0,0,0.05);background:#fff;}
        .badge-in{background:#d1fae5;color:#065f46;} .badge-out{background:#fee2e2;color:#991b1b;}
        .btn-lock-on{background:#ef4444;color:white;animation:pulse 2s infinite;}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(239,68,68,0.7);}70%{box-shadow:0 0 0 10px rgba(0,0,0,0);}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);}}
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="text-center fw-bold text-primary mb-4">KEBOREE</h3>
    <a class="nav-link active" onclick="view('dash',this)"><i class="bi bi-grid me-2"></i> Dashboard</a>
    <a class="nav-link" onclick="view('reg',this)"><i class="bi bi-person-vcard me-2"></i> Registration</a>
    <a class="nav-link" onclick="view('logs',this)"><i class="bi bi-list-task me-2"></i> Logs</a>
    <a class="nav-link" onclick="view('alert',this)"><i class="bi bi-bell me-2"></i> Alerts <span id="alertBadge" class="badge bg-danger ms-2" style="display:none">0</span></a>
    <a class="nav-link" onclick="view('staff',this)"><i class="bi bi-people me-2"></i> Staff</a>
    <a class="nav-link" onclick="view('events',this)"><i class="bi bi-calendar me-2"></i> Events</a>
    <a class="nav-link mt-5 text-danger" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</a>
</div>

<div class="main">
    <div class="d-flex justify-content-between mb-4">
        <h3 id="pgTitle">Dashboard</h3>
        <div>
            <button id="btnLock" onclick="toggleLock()" class="btn btn-outline-success fw-bold">System Active</button>
            <button onclick="broadcast()" class="btn btn-dark ms-2">Broadcast</button>
        </div>
    </div>

    <div id="dash" class="page">
        <div class="row g-3 mb-4">
            <div class="col-md-4"><div class="card p-4"><h6>Total Registered</h6><h2 id="totReg">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h6>Total Scans</h6><h2 id="totScan">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h6>Status</h6><h4 class="text-success">Online</h4></div></div>
        </div>
        <h5>Live Events</h5>
        <div id="liveCards" class="row g-3"></div>
    </div>

    <div id="reg" class="page" style="display:none;">
        <div class="card p-4">
            <h5>Bulk Register</h5>
            <div class="row">
                <div class="col-md-3"><input id="regT" class="form-control" placeholder="Troop No"></div>
                <div class="col-md-9"><textarea id="regD" class="form-control" rows="5" placeholder="Name, Troop Name, District..."></textarea></div>
            </div>
            <button onclick="doReg()" class="btn btn-primary w-100 mt-3">Register & Generate</button>
            <hr>
            <button id="btnPDF" onclick="dlPDF()" class="btn btn-dark" disabled>Download PDF</button>
            <div id="qrArea" class="row g-2 mt-3 bg-light p-2" style="height:300px;overflow:auto;"></div>
        </div>
    </div>

    <div id="logs" class="page" style="display:none;">
        <div class="card p-4">
            <h5>Live Logs</h5>
            <table class="table"><thead class="table-light"><tr><th>Time</th><th>ID</th><th>Event</th><th>Action</th></tr></thead><tbody id="logTab"></tbody></table>
        </div>
    </div>

    <div id="alert" class="page" style="display:none;">
        <button onclick="clrAlert()" class="btn btn-sm btn-light border mb-3">Clear All</button>
        <div id="alertBox"></div>
    </div>

    <div id="hiddenQr" style="display:none;"></div>
    
    <div id="events" class="page" style="display:none;"><div class="card p-4"><input id="en" placeholder="Name" class="form-control mb-2"><input id="eb" placeholder="Buttons (IN,OUT)" class="form-control mb-2"><button onclick="addEv()" class="btn btn-primary">Add Event</button><div id="evL" class="mt-3"></div></div></div>
    <div id="staff" class="page" style="display:none;"><div class="card p-4"><input id="se" placeholder="Email" class="form-control mb-2"><input id="sp" placeholder="Pass" class="form-control mb-2"><select id="sr" class="form-control mb-2"><option value="scanner">Scanner</option><option value="admin">Admin</option></select><button onclick="addSt()" class="btn btn-primary">Add Staff</button></div></div>
</div>

<audio id="snd" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);
    const sec = initializeApp(firebaseConfig,"Sec").getAuth();
    
    let locked=false, tempS=[];

    onAuthStateChanged(auth, u=>{ if(!u) location.href="index.html"; else init(); });

    function init() {
        // Lock
        onValue(ref(rtdb,'system/status/locked'), s=>{
            locked=s.val();
            document.getElementById('btnLock').className = locked ? "btn btn-lock-on" : "btn btn-outline-success fw-bold";
            document.getElementById('btnLock').innerText = locked ? "SYSTEM LOCKED" : "System Active";
        });

        // Logs
        onValue(ref(rtdb,'logs'), s=>{
            const d=s.val(); if(!d) return;
            const l=Object.values(d);
            document.getElementById('totScan').innerText=l.length;
            let h="";
            l.slice(-50).reverse().forEach(x=>{
                let t = new Date(x.timestamp).toLocaleTimeString();
                let c = x.action.includes('IN')?'badge-in':'badge-out';
                h+=`<tr><td>${t}</td><td><b>${x.scoutID}</b><br><small>${x.scoutName}</small></td><td>${x.eventName}</td><td><span class="badge ${c}">${x.action}</span></td></tr>`;
            });
            document.getElementById('logTab').innerHTML=h;

            // Cards
            let st={}; l.forEach(x=>{ if(!st[x.eventName])st[x.eventName]={in:0,out:0}; if(x.action.includes('IN'))st[x.eventName].in++; if(x.action.includes('OUT'))st[x.eventName].out++; });
            let ch=""; Object.keys(st).forEach(k=>{ ch+=`<div class="col-md-3"><div class="card p-3 border-primary"><h6>${k}</h6><h3>${Math.max(0, st[k].in-st[k].out)} <small class="fs-6 text-muted">Inside</small></h3></div></div>`; });
            document.getElementById('liveCards').innerHTML=ch;
        });

        // Alerts
        onValue(ref(rtdb,'system/alerts'), s=>{
            const d=s.val(); if(!d) { document.getElementById('alertBox').innerHTML=""; return; }
            const a=Object.values(d).reverse();
            document.getElementById('alertBadge').innerText=a.length; document.getElementById('alertBadge').style.display='inline-block';
            let h=""; a.forEach(x=>{ h+=`<div class="alert alert-danger">⚠️ Found: <b>${x.scoutName}</b> (${new Date(x.timestamp).toLocaleTimeString()})</div>`; });
            document.getElementById('alertBox').innerHTML=h; document.getElementById('snd').play().catch(()=>{});
        });

        onSnapshot(collection(db,"scouts"), s=>document.getElementById('totReg').innerText=s.size);
        onSnapshot(collection(db,"events"), s=>{ let h=""; s.forEach(d=>h+=`<div class="border p-2 mb-1">${d.data().name}</div>`); document.getElementById('evL').innerHTML=h; });
    }

    // REGISTRATION (FIXED)
    window.doReg = async () => {
        const tr=document.getElementById('regT').value; const tx=document.getElementById('regD').value;
        if(!tr||!tx) return alert('Data Missing');
        
        let id=1; try{const c=await getDoc(doc(db,"system","cnt")); if(c.exists())id=c.data().v+1;}catch(e){}
        tempS=[]; let h="";
        
        for(let l of tx.split('\n')) {
            let p=l.split(','); if(p.length>=1){
                let sid=`KG${tr}/${id.toString().padStart(3,'0')}`;
                let did=`KG${tr}_${id.toString().padStart(3,'0')}`;
                let d={id:sid, name:p[0], troop:`Troop ${tr}`, isMissing:false};
                await setDoc(doc(db,"scouts",did), d);
                tempS.push(d);
                h+=`<div class="col-3 border p-2 text-center"><div id="q_${id}"></div><small>${sid}</small></div>`;
                id++;
            }
        }
        await setDoc(doc(db,"system","cnt"),{v:id-1});
        document.getElementById('qrArea').innerHTML=h;
        
        setTimeout(()=>{
            tempS.forEach((s,i)=>{ new QRCode(document.getElementById(`q_${i+1}`),{text:s.id,width:80,height:80}); });
            document.getElementById('btnPDF').disabled=false;
        },500);
        alert('Registered!');
    }

    window.dlPDF = () => {
        const doc=new window.jspdf.jsPDF(); let x=10,y=10,c=0,r=0;
        tempS.forEach((s,i)=>{
            if(i>0&&i%16==0){doc.addPage();c=0;r=0;}
            let cx=10+(c*47), cy=10+(r*67); doc.rect(cx,cy,45,65);
            doc.setFontSize(10); doc.text(s.id,cx+22,cy+40,{align:'center'});
            doc.setFontSize(8); doc.text(s.name.substring(0,15),cx+22,cy+45,{align:'center'});
            let img=document.getElementById(`q_${i+1}`).querySelector('img');
            if(img) doc.addImage(img.src,'PNG',cx+10,cy+10,25,25);
            c++;if(c>=4){c=0;r++;}
        }); doc.save('IDs.pdf');
    }

    // ACTIONS
    window.toggleLock = async () => await set(ref(rtdb,'system/status/locked'), !locked);
    window.broadcast = async () => { const m=prompt("Msg?"); if(m) await set(ref(rtdb,'system/broadcast'),{m:m,t:Date.now()}); }
    window.clrAlert = async () => { if(confirm('Clear?')) await remove(ref(rtdb,'system/alerts')); }
    window.addEv = async () => { await setDoc(doc(collection(db,"events")),{name:document.getElementById('en').value,actions:document.getElementById('eb').value.split(','),active:true}); }
    window.addSt = async () => { await createUserWithEmailAndPassword(sec,document.getElementById('se').value,document.getElementById('sp').value); await setDoc(doc(db,"users",document.getElementById('se').value),{role:document.getElementById('sr').value}); alert('Added'); }
    
    window.view = (v,e) => { document.querySelectorAll('.page').forEach(x=>x.style.display='none'); document.getElementById(v).style.display='block'; document.getElementById('pgTitle').innerText=v.toUpperCase(); }
    window.logout = () => signOut(auth).then(()=>location.href='index.html');
</script>
</body>
</html>
