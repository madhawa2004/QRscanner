<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, onSnapshot, serverTimestamp, getDoc, query, where, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, onValue, set, remove, push, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    let currentUserRole = 'moderator';

    onAuthStateChanged(auth, async (user) => { 
        if (!user) window.location.href="index.html"; 
        else { 
            try {
                const uDoc = await getDoc(doc(db, "users", user.email));
                if(uDoc.exists()) currentUserRole = uDoc.data().role;
                document.getElementById('userRoleDisplay').innerText = currentUserRole.toUpperCase();
                if(currentUserRole === 'moderator') {
                    document.getElementById('nav-staff').style.display = 'none'; 
                    document.getElementById('btn-emergency').style.display = 'none'; 
                    document.getElementById('btnLock').style.display = 'none';
                }
            } catch(e){}
            initListeners(); 
        } 
    });

    function initListeners() { 
        loadUsers(); loadEvents(); loadLogs(); loadStats(); listenForEmergencies(); listenSystemLock(); listenForAlerts();
    }

    // üî• LOGS FIX: Using Number Timestamp
    function loadLogs() {
        const logsRef = ref(rtdb, 'logs');
        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const logsArr = Object.values(data);
                document.getElementById('statTotalScans').innerText = logsArr.length;
                // ... Stats logic same as before ...

                const recentLogs = logsArr.reverse().slice(0, 50);
                let h = "";
                recentLogs.forEach(l => {
                    // ‚è∞ TIME DISPLAY FIX
                    let timeStr = "N/A";
                    if (l.timestamp) {
                        timeStr = new Date(l.timestamp).toLocaleTimeString();
                    }

                    let act = l.action || "-";
                    let cls = act.includes('IN') ? 'badge-in' : (act.includes('OUT') ? 'badge-out' : 'badge-other');

                    h += `<tr>
                        <td class="ps-3 small fw-bold text-muted">${timeStr}</td>
                        <td><strong>${l.scoutID}</strong><br><small class="text-muted">${l.scoutName} ‚Ä¢ ${l.scoutTroop}</small></td>
                        <td>${l.eventName}</td>
                        <td><span class="badge ${cls}">${act}</span></td>
                        <td class="pe-3 small text-muted">${l.scannedBy.split('@')[0]}</td>
                    </tr>`;
                });
                document.getElementById('logsTableBody').innerHTML = h;
            }
        });
    }

    // ... (Search, Reg, Staff, Reports functions - Keep same as previous code) ...
    
    // üî• LOCK & ALERTS LOGIC
    function listenSystemLock() {
        onValue(ref(rtdb, 'system/status/locked'), s => {
            const locked = s.val() || false;
            const btn = document.getElementById('btnLock');
            const status = document.getElementById('sysStatusText');
            if(locked) {
                btn.className = "btn btn-danger fw-bold"; btn.innerText = "SYSTEM LOCKED";
                status.innerText = "LOCKED"; status.className = "fw-bold text-danger";
            } else {
                btn.className = "btn btn-outline-success fw-bold"; btn.innerText = "SYSTEM ACTIVE";
                status.innerText = "Online"; status.className = "fw-bold text-success";
            }
        });
    }
    window.toggleSystemLock = async () => { if(currentUserRole==='admin') await set(ref(rtdb, 'system/status/locked'), !(document.getElementById('sysStatusText').innerText === 'LOCKED')); }

    function listenForAlerts() {
        onValue(ref(rtdb, 'system/alerts'), snap => {
            const data = snap.val();
            if(data) {
                const alerts = Object.values(data).reverse();
                document.getElementById('navAlertBadge').innerText = alerts.length;
                document.getElementById('navAlertBadge').style.display = 'inline-block';
                let h = "";
                alerts.forEach(a => {
                    h += `<div class="card p-3 mb-2 border-danger"><h6 class="text-danger fw-bold">FOUND: ${a.scoutName}</h6><small>${new Date(a.timestamp).toLocaleTimeString()}</small></div>`;
                });
                document.getElementById('alertsContainer').innerHTML = h;
            }
        });
    }
    window.clearAlerts = async () => { if(confirm("Clear All?")) await remove(ref(rtdb, 'system/alerts')); }

    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    window.loadView=(v)=>{document.querySelectorAll('.view-section').forEach(d=>d.style.display='none');document.getElementById('view-'+v).style.display='block';}
    
    // (Import other existing functions here: saveNewEvent, createNewUser etc.)
    // NOTE: For brevity, I assumed you keep the other standard functions from previous valid code.
</script>
