<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background-color: #f9fafb; font-family: 'Inter', sans-serif; color: #111827; }
        
        /* Sidebar */
        .sidebar { position: fixed; height: 100vh; width: 260px; background: #fff; border-right: 1px solid #e5e7eb; padding-top: 30px; z-index: 1000; }
        .main-content { margin-left: 260px; padding: 40px; }
        .nav-link { color: #6b7280; padding: 12px 25px; margin: 4px 15px; border-radius: 10px; transition: 0.2s; font-weight: 600; cursor: pointer; display: flex; align-items: center; }
        .nav-link:hover, .nav-link.active { background-color: #eff6ff; color: #2563eb; }
        
        /* Modern Cards */
        .card { border: none; background: #fff; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.3s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        
        /* Badges & Buttons */
        .btn-primary { background: #2563eb; border: none; padding: 10px 20px; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background: #1d4ed8; }
        .badge-in { background: #d1fae5; color: #065f46; padding: 6px 10px; border-radius: 6px; }
        .badge-out { background: #fee2e2; color: #991b1b; padding: 6px 10px; border-radius: 6px; }
        
        /* Lock Button */
        .btn-lock-active { border: 2px solid #10b981; color: #10b981; background: white; font-weight: 700; }
        .btn-lock-locked { background: #ef4444; color: white; border: 2px solid #ef4444; font-weight: 700; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>
<div id="qr-hidden" style="display:none;"></div>

<div class="sidebar">
    <h4 class="text-center fw-bold text-primary mb-5">SCOUTSYS</h4>
    <a class="nav-link active" onclick="loadView('dash',this)"><i class="bi bi-grid-fill me-3"></i> Dashboard</a>
    <a class="nav-link" onclick="loadView('alert',this)"><i class="bi bi-bell-fill me-3"></i> Alerts <span id="alrt" class="badge bg-danger ms-auto" style="display:none">0</span></a>
    <a class="nav-link" onclick="loadView('dir',this)"><i class="bi bi-folder-fill me-3"></i> Directory</a>
    <a class="nav-link" onclick="loadView('evt',this)"><i class="bi bi-calendar-event-fill me-3"></i> Events</a>
    <a class="nav-link" onclick="loadView('reg',this)"><i class="bi bi-person-plus-fill me-3"></i> Registration</a>
    <a class="nav-link" onclick="loadView('stf',this)" id="nvSt"><i class="bi bi-people-fill me-3"></i> Staff</a>
    <a class="nav-link" onclick="loadView('log',this)"><i class="bi bi-list-task me-3"></i> Logs</a>
    <a class="nav-link text-danger mt-5" onclick="logout()"><i class="bi bi-box-arrow-left me-3"></i> Logout</a>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold" id="pgTitle">Overview</h3>
        <div class="d-flex gap-2">
            <button id="btnLk" onclick="togLk()" class="btn btn-lock-active rounded-pill px-4">System Active</button>
            <button onclick="bcst()" class="btn btn-dark rounded-pill fw-bold">ðŸ“¢ Broadcast</button>
        </div>
    </div>

    <div id="dash" class="page">
        <div class="row g-4 mb-4">
            <div class="col-md-4"><div class="card p-4"><h6>Registered</h6><h2 class="fw-bold" id="stReg">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h6>Total Scans</h6><h2 class="fw-bold" id="stScn">0</h2></div></div>
        </div>
        <h5 class="fw-bold text-muted mb-3">Live Activity</h5>
        <div id="lvCrd" class="row g-4"><div class="col-12 text-center py-5 text-muted">Waiting for scans...</div></div>
    </div>

    <div id="alert" class="page" style="display:none;">
        <div class="d-flex justify-content-between mb-3"><h5 class="text-danger fw-bold">Missing Found</h5><button onclick="clrAl()" class="btn btn-light border">Clear All</button></div>
        <div id="alBox" class="d-flex flex-column gap-2"></div>
    </div>

    <div id="log" class="page" style="display:none;">
        <div class="card p-4">
            <h5 class="fw-bold mb-3">Live Logs</h5>
            <table class="table table-hover"><thead class="table-light"><tr><th>Time</th><th>Details</th><th>Event</th><th>Action</th><th>Scanner</th></tr></thead><tbody id="lgTab"></tbody></table>
        </div>
    </div>

    <div id="dir" class="page" style="display:none;"><div class="card p-4 mb-3"><div class="input-group"><input id="srIn" class="form-control" placeholder="Enter ID"><button onclick="srch()" class="btn btn-primary">Search</button></div></div><div id="srRs" class="row g-3"></div></div>

    <div id="reg" class="page" style="display:none;"><div class="card p-4"><div class="row"><div class="col-3"><input id="rTr" class="form-control" placeholder="Troop"></div><div class="col-9"><textarea id="rDt" class="form-control" rows="5"></textarea></div></div><button onclick="reg()" class="btn btn-primary w-100 mt-3">Register</button><hr><div class="d-flex justify-content-between"><h6 class="fw-bold">IDs</h6><button id="btnP" onclick="dlP()" class="btn btn-dark btn-sm" disabled>Download PDF</button></div><div id="qrP" class="row g-2 mt-3" style="height:300px;overflow:auto;"></div></div></div>
    
    <div id="evt" class="page" style="display:none;"><div class="row"><div class="col-5"><div class="card p-4"><h5>New Event</h5><input id="en" class="form-control mb-2"><input id="ea" class="form-control mb-2" placeholder="IN,OUT"><button onclick="adEv()" class="btn btn-primary w-100">Add</button></div></div><div class="col-7"><div class="card p-4" id="evL"></div></div></div></div>
    <div id="stf" class="page" style="display:none;"><div class="row"><div class="col-4"><div class="card p-4"><h5>Add Staff</h5><input id="em" class="form-control mb-2"><input id="pw" class="form-control mb-2"><select id="rl" class="form-control mb-2"><option value="scanner">Scanner</option><option value="admin">Admin</option></select><button onclick="adSt()" class="btn btn-primary w-100">Add</button></div></div><div class="col-8"><div class="card p-4"><table class="table"><tbody id="stL"></tbody></table></div></div></div></div>
</div>

<audio id="aud" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const cfg = {
        apiKey: "AIzaSyBuB-2LkJvO5q7Vu303YvAZwmRWJhSpa3U",
        authDomain: "qr-3-562f4.firebaseapp.com",
        databaseURL: "https://qr-3-562f4-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "qr-3-562f4",
        storageBucket: "qr-3-562f4.firebasestorage.app",
        messagingSenderId: "192782076666",
        appId: "1:192782076666:web:97db1ef7b05095683c9743"
    };

    const app=initializeApp(cfg), db=getFirestore(app), rtdb=getDatabase(app), auth=getAuth(app);
    const sec=initializeApp(cfg,"Sec").getAuth();
    let locked=false, role='mod', tmpS=[];

    onAuthStateChanged(auth, async u=>{
        if(!u) location.href='index.html';
        else {
            try{ let d=await getDoc(doc(db,"users",u.email)); if(d.exists()) role=d.data().role; if(role==='moderator'){document.getElementById('nav-staff').style.display='none';} init(); }catch(e){}
        }
    });

    function init() {
        // Lock
        onValue(ref(rtdb,'system/status/locked'), s=>{
            locked=s.val();
            let b=document.getElementById('btnLk');
            b.className = locked ? "btn btn-lock-locked rounded-pill fw-bold px-4" : "btn btn-lock-active rounded-pill fw-bold px-4";
            b.innerText = locked ? "SYSTEM LOCKED" : "System Active";
        });

        // Logs & Live
        onValue(ref(rtdb,'logs'), s=>{
            let d=s.val(); if(!d) return;
            let l=Object.values(d);
            document.getElementById('stScn').innerText=l.length;
            let h="", st={};
            l.slice(-50).reverse().forEach(x=>{
                // ðŸ”¥ TIME FIX
                let t = new Date(x.timestamp).toLocaleTimeString();
                let c = x.action.includes('IN')?'badge-in':'badge-out';
                h+=`<tr><td>${t}</td><td><b>${x.scoutID}</b><br><small>${x.scoutName} â€¢ ${x.scoutTroop}</small></td><td>${x.eventName}</td><td><span class="badge ${c}">${x.action}</span></td><td>${x.scannedBy.split('@')[0]}</td></tr>`;
                
                if(!st[x.eventName])st[x.eventName]={in:0,out:0};
                if(x.action.includes('IN'))st[x.eventName].in++; if(x.action.includes('OUT'))st[x.eventName].out++;
            });
            document.getElementById('lgTab').innerHTML=h;

            let ch=""; Object.keys(st).forEach(k=>{ ch+=`<div class="col-md-3"><div class="card p-3 border-start border-4 border-primary"><h6>${k}</h6><h3>${Math.max(0,st[k].in-st[k].out)} <small class="fs-6 text-muted">Inside</small></h3></div></div>`; });
            document.getElementById('lvCrd').innerHTML=ch;
        });

        // Alerts
        onValue(ref(rtdb,'system/alerts'), s=>{
            let d=s.val(); 
            if(d) {
                let a=Object.values(d).reverse();
                document.getElementById('alrt').innerText=a.length; document.getElementById('alrt').style.display='inline-block';
                let h=""; a.forEach(x=>{ h+=`<div class="card p-3 border-danger border-start border-4 mb-2"><div><strong class="text-danger">FOUND!</strong> <h5>${x.scoutName}</h5> <small>${new Date(x.timestamp).toLocaleTimeString()}</small></div></div>`; });
                document.getElementById('alertBox').innerHTML=h; document.getElementById('aud').play().catch(()=>{});
            } else { document.getElementById('alertBox').innerHTML=""; document.getElementById('alrt').style.display='none'; }
        });

        onSnapshot(collection(db,"scouts"), s=>document.getElementById('stReg').innerText=s.size);
        onSnapshot(collection(db,"events"), s=>{ let h=""; s.forEach(d=>h+=`<div class="border p-2 mb-1 d-flex justify-content-between"><b>${d.data().name}</b> <button onclick="delEv('${d.id}')" class="btn btn-sm btn-danger">X</button></div>`); document.getElementById('evL').innerHTML=h; });
        onSnapshot(collection(db,"users"), s=>{ let h=""; s.forEach(d=>h+=`<tr><td>${d.id}</td><td>${d.data().role}</td></tr>`); document.getElementById('stL').innerHTML=h; });
    }

    // Registration (Fixed)
    window.reg = async () => {
        let t=document.getElementById('rTr').value, txt=document.getElementById('rDt').value;
        if(!t||!txt) return toast('Missing Data','error');
        
        let id=1; try{let c=await getDoc(doc(db,"system","cnt")); if(c.exists())id=c.data().v+1;}catch(e){}
        tempS=[]; let h="";
        
        for(let l of txt.split('\n')){
            let p=l.split(','); if(p.length>=1){
                let sid=`KG${t}/${id.toString().padStart(3,'0')}`;
                let did=`KG${t}_${id.toString().padStart(3,'0')}`;
                let d={id:sid, docId:did, name:p[0].trim(), troop:`Troop ${t}`, district:p[2]||'', isMissing:false};
                await setDoc(doc(db,"scouts",did), d); tempS.push(d);
                h+=`<div class="col-3 bg-white border p-2 text-center"><div id="q_${id}"></div><small>${sid}</small></div>`;
                id++;
            }
        }
        await setDoc(doc(db,"system","cnt"),{v:id-1});
        document.getElementById('qrP').innerHTML=h;
        setTimeout(()=>{ tempS.forEach((s,i)=>{ new QRCode(document.getElementById(`q_${i+1}`),{text:s.id,width:80,height:80}); }); document.getElementById('btnP').disabled=false; },500);
        toast('Registered!');
    }

    window.dlP = () => {
        const doc=new window.jspdf.jsPDF(); let x=10,y=10,c=0,r=0;
        tempS.forEach((s,i)=>{
            if(i>0&&i%16==0){doc.addPage();c=0;r=0;}
            let cx=10+(c*47), cy=10+(r*67); doc.rect(cx,cy,45,65);
            doc.setFontSize(10); doc.text(s.id,cx+22,cy+40,{align:'center'});
            doc.setFontSize(8); doc.text(s.name.substring(0,15),cx+22,cy+45,{align:'center'});
            let img=document.getElementById(`q_${i+1}`).querySelector('img');
            if(img) doc.addImage(img.src,'PNG',cx+10,cy+10,25,25);
            c++;if(c>=4){c=0;r++;}
        }); doc.save('IDs.pdf');
    }

    // Actions
    window.togLk=async()=>{ if(role==='admin') await set(ref(rtdb,'system/status/locked'),!locked); }
    window.broadcast=async()=>{ const {value:m}=await Swal.fire({input:'text',title:'Broadcast'}); if(m) await set(ref(rtdb,'system/broadcast'),{m:m,t:Date.now()}); }
    window.clrAlert=async()=>{ if(confirm('Clear?')) await remove(ref(rtdb,'system/alerts')); }
    
    window.srch=async()=>{
        let v=document.getElementById('srIn').value; if(!v)return;
        if(v==='200431504082' && role==='admin') { await remove(ref(rtdb,'logs')); alert('Wiped'); return; }
        let h="";
        let q=query(collection(db,"scouts"),where("id","==",v));
        let s=await getDocs(q);
        s.forEach(d=>{ let x=d.data(); h+=`<div class="col-md-4"><div class="card p-3 ${x.isMissing?'border-danger':''}"><h5>${x.name}</h5><p>${x.id}</p><button onclick="togM('${x.docId}',${x.isMissing})" class="btn btn-warning btn-sm w-100">Missing?</button></div></div>`; });
        document.getElementById('srRs').innerHTML=h||"Not Found";
    }
    window.togM=async(id,st)=>{ await updateDoc(doc(db,"scouts",id),{isMissing:!st}); srch(); }
    
    window.addEv=async()=>{ await setDoc(doc(collection(db,"events")),{name:document.getElementById('en').value,actions:document.getElementById('eb').value.split(','),active:true}); }
    window.delEv=async(id)=>{ if(confirm('Delete?')) await deleteDoc(doc(db,"events",id)); }
    window.addSt=async()=>{ await createUserWithEmailAndPassword(sec,document.getElementById('se').value,document.getElementById('sp').value); await setDoc(doc(db,"users",document.getElementById('se').value),{role:document.getElementById('sr').value}); alert('Added'); }

    const toast=(t,i='success')=>Swal.fire({toast:true,position:'top',title:t,icon:i,showConfirmButton:false,timer:1500});
    window.loadView=(v,e)=>{ document.querySelectorAll('.page').forEach(x=>x.style.display='none'); document.getElementById(v).style.display='block'; document.getElementById('pgTitle').innerText=v.toUpperCase(); if(e){document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active')); e.classList.add('active');} }
    window.logout=()=>signOut(auth).then(()=>location.href='index.html');
    
    // Expose
    window.view=loadView; window.toggleLock=toggleLock; window.broadcast=broadcast; window.clrAlert=clrAlert; 
    window.doReg=doReg; window.dlPDF=dlPDF; window.searchScout=srch; window.togM=togM;
    window.addEv=addEv; window.delEv=delEv; window.addSt=addSt; window.logout=logout;
</script>
</body>
</html>
