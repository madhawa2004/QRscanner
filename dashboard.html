<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEBOREE ADMIN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body{background:#f4f6f9;} .sidebar{height:100vh;width:250px;position:fixed;background:#fff;padding-top:20px;border-right:1px solid #ddd;}
        .main{margin-left:250px;padding:30px;} .nav-link{padding:15px;color:#555;cursor:pointer;} .nav-link:hover{background:#f0f0f0;}
        .card{border:none;border-radius:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);}
        .hidden{display:none;} .badge-in{background:#d1fae5;color:#065f46;} .badge-out{background:#fee2e2;color:#991b1b;}
    </style>
</head>
<body>

<div class="sidebar">
    <h3 class="text-center fw-bold text-primary">KEBOREE</h3>
    <div class="nav flex-column mt-4">
        <a class="nav-link" onclick="show('dashboard')"><i class="bi bi-grid me-2"></i> Dashboard</a>
        <a class="nav-link" onclick="show('logs')"><i class="bi bi-list-task me-2"></i> Scan Logs</a>
        <a class="nav-link" onclick="show('reg')"><i class="bi bi-person-plus me-2"></i> Registration</a>
        <a class="nav-link" onclick="show('staff')"><i class="bi bi-people me-2"></i> Staff</a>
        <a class="nav-link text-danger mt-5" onclick="logout()">Logout</a>
    </div>
</div>

<div class="main">
    <div class="d-flex justify-content-between mb-4">
        <h4>Admin Panel</h4>
        <div>
            <button id="btnLock" onclick="toggleLock()" class="btn btn-success">System Active</button>
            <button onclick="broadcast()" class="btn btn-danger ms-2">Broadcast</button>
        </div>
    </div>

    <div id="dashboard" class="page">
        <div class="row g-3">
            <div class="col-md-4"><div class="card p-4"><h5>Total Scouts</h5><h2 id="totScouts">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h5>Total Scans</h5><h2 id="totLogs">0</h2></div></div>
            <div class="col-md-4"><div class="card p-4"><h5>Status</h5><h4 class="text-success">Online</h4></div></div>
        </div>
        <div id="alertsBox" class="mt-4"></div>
    </div>

    <div id="logs" class="page hidden">
        <div class="card p-4">
            <h5>Live Logs</h5>
            <table class="table"><thead class="table-light"><tr><th>Time</th><th>ID</th><th>Event</th><th>Action</th></tr></thead><tbody id="logTable"></tbody></table>
        </div>
    </div>

    <div id="reg" class="page hidden">
        <div class="card p-4">
            <h5>Register Scouts</h5>
            <input id="regTroop" class="form-control mb-2" placeholder="Troop No (e.g. 25)">
            <textarea id="regData" class="form-control mb-2" rows="5" placeholder="Name, Troop, District..."></textarea>
            <button onclick="register()" class="btn btn-primary w-100">Generate IDs</button>
            <hr>
            <button onclick="downloadPDF()" class="btn btn-dark w-100" id="dlBtn" disabled>Download PDF</button>
            <div id="qrArea" class="row g-2 mt-3 bg-light p-2"></div>
        </div>
    </div>

    <div id="staff" class="page hidden">
        <div class="card p-4">
            <input id="sEmail" class="form-control mb-2" placeholder="Email">
            <input id="sPass" class="form-control mb-2" placeholder="Password">
            <select id="sRole" class="form-select mb-2"><option value="scanner">Scanner</option><option value="admin">Admin</option></select>
            <button onclick="addStaff()" class="btn btn-primary">Add User</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, set, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî• YOUR FIXED CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);
    const secAuth = initializeApp(firebaseConfig, "Secondary").getAuth(); // For creating users

    let isLocked = false;
    window.tempScouts = [];

    onAuthStateChanged(auth, u => { if(!u) window.location.href="index.html"; else init(); });

    function init() {
        // Lock Status
        onValue(ref(rtdb, 'system/status/locked'), s => {
            isLocked = s.val() || false;
            const btn = document.getElementById('btnLock');
            if(isLocked) { btn.innerText="SYSTEM LOCKED"; btn.className="btn btn-danger"; }
            else { btn.innerText="SYSTEM ACTIVE"; btn.className="btn btn-success"; }
        });

        // Logs
        onValue(ref(rtdb, 'logs'), s => {
            const d = s.val();
            if(d) {
                const logs = Object.values(d).reverse().slice(0,50);
                document.getElementById('totLogs').innerText = Object.keys(d).length;
                let h = "";
                logs.forEach(l => {
                    let time = l.timestamp ? new Date(l.timestamp).toLocaleTimeString() : "N/A"; // ‚úÖ Fixed Time
                    let cls = l.action.includes('IN') ? 'badge-in' : 'badge-out';
                    h += `<tr><td>${time}</td><td>${l.scoutID}<br><small class="text-muted">${l.scoutName}</small></td><td>${l.eventName}</td><td><span class="badge ${cls}">${l.action}</span></td></tr>`;
                });
                document.getElementById('logTable').innerHTML = h;
            }
        });
        
        // Missing Alerts
        onValue(ref(rtdb, 'system/alerts'), s => {
            const d = s.val();
            let h = "";
            if(d) {
                Object.values(d).reverse().forEach(a => {
                    h += `<div class="alert alert-danger">‚ö†Ô∏è Found: <b>${a.scoutName}</b> by ${a.scanner}</div>`;
                });
            }
            document.getElementById('alertsBox').innerHTML = h;
        });

        onSnapshot(collection(db, "scouts"), s => document.getElementById('totScouts').innerText = s.size);
    }

    window.toggleLock = async () => await set(ref(rtdb, 'system/status/locked'), !isLocked);
    window.broadcast = async () => { const m = prompt("Message?"); if(m) await set(ref(rtdb, 'system/broadcast'), {message:m, timestamp:Date.now()}); }
    
    window.registerScouts = async () => {
        const tr = document.getElementById('regTroop').value;
        const txt = document.getElementById('regData').value;
        if(!tr || !txt) return alert("Missing Info");

        let id = 1; 
        try { const c = await getDoc(doc(db,"system","scout_counter")); if(c.exists()) id = c.data().val + 1; }catch(e){}

        const lines = txt.split('\n');
        window.tempScouts = [];
        let previewHTML = "";

        for(let l of lines) {
            let p = l.split(',');
            if(p.length>=1) {
                let sid = `KG${tr}/${id.toString().padStart(3,'0')}`;
                let did = `KG${tr}_${id.toString().padStart(3,'0')}`;
                let data = {id:sid, name:p[0], troop:`Troop ${tr}`, docId:did, isMissing:false};
                
                await setDoc(doc(db,"scouts",did), data);
                window.tempScouts.push(data);
                previewHTML += `<div class="col-3 text-center border p-2"><div id="qr_${id}"></div><small>${sid}</small></div>`;
                id++;
            }
        }
        await setDoc(doc(db,"system","scout_counter"), {val:id-1});
        
        document.getElementById('qrArea').innerHTML = previewHTML;
        
        // Generate QR
        setTimeout(() => {
            window.tempScouts.forEach((s, index) => {
                // Calculate original index based on counter isn't reliable for DOM ID, using array index logic
                // Fix: Using array index for DOM query
                let qrContainer = document.querySelector(`#qrArea > div:nth-child(${index+1}) > div`);
                new QRCode(qrContainer, {text: s.id, width: 80, height: 80});
            });
            document.getElementById('dlBtn').disabled = false;
        }, 1000);
    }

    window.downloadPDF = () => {
        const doc = new window.jspdf.jsPDF();
        let x=10, y=10, c=0, r=0;
        window.tempScouts.forEach((s, i) => {
            if(i>0 && i%16===0) { doc.addPage(); c=0; r=0; }
            let cx = 10+(c*47); let cy = 10+(r*67);
            doc.rect(cx,cy,45,65);
            doc.setFontSize(10); doc.text(s.id, cx+22, cy+40, {align:'center'});
            
            // Get QR image from DOM
            let qrEl = document.querySelector(`#qrArea > div:nth-child(${i+1}) > div img`);
            if(qrEl) doc.addImage(qrEl.src, 'PNG', cx+10, cy+10, 25, 25);
            
            c++; if(c>=4) {c=0; r++;}
        });
        doc.save("IDs.pdf");
    }

    window.addStaff = async () => {
        try {
            await createUserWithEmailAndPassword(secAuth, document.getElementById('sEmail').value, document.getElementById('sPass').value);
            await setDoc(doc(db,"users",document.getElementById('sEmail').value), {role:document.getElementById('sRole').value});
            alert('Added');
        } catch(e) { alert(e.message); }
    }

    window.show = (id) => { document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    window.logout = () => signOut(auth).then(()=>location.href="index.html");

    // Expose
    window.toggleLock=toggleLock; window.broadcast=broadcast; window.register=registerScouts; window.downloadPDF=downloadPDF; window.addStaff=addStaff; window.show=show; window.logout=logout;
</script>
</body>
</html>
