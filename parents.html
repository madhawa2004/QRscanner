<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; color: #4b5563; }
        .container { max-width: 600px; padding-top: 40px; }
        .search-wrapper { background: #fff; border-radius: 25px; padding: 40px 30px; box-shadow: 0 15px 40px rgba(108, 92, 231, 0.1); text-align: center; }
        .search-input { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 50px; padding: 15px 25px; font-size: 1.1rem; text-align: center; font-weight: 500; }
        .btn-search { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; border-radius: 50px; padding: 12px 30px; border: none; font-weight: 600; margin-top: 15px; width: 100%; }
        .profile-view { display: none; }
        .profile-header { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white; border-radius: 20px; padding: 30px; text-align: center; box-shadow: 0 10px 30px rgba(108, 92, 231, 0.3); margin-bottom: 25px; position: relative; }
        .timeline-box { background: #fff; border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
        .timeline-item { border-left: 2px solid #e9ecef; padding-left: 20px; padding-bottom: 25px; position: relative; }
        .timeline-dot { width: 12px; height: 12px; background: #6c5ce7; border-radius: 50%; position: absolute; left: -7px; top: 5px; box-shadow: 0 0 0 4px #fff; }
        .missing-banner { background: #ff7675; color: white; padding: 15px; border-radius: 15px; text-align: center; font-weight: bold; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="searchView">
        <div class="search-wrapper animate__animated animate__fadeInDown">
            <h3 class="fw-bold">Find Scout</h3>
            <p class="text-muted small mb-4">Enter exact ID</p>
            <input type="text" id="searchInput" class="form-control search-input" placeholder="e.g. KG25/001">
            <button onclick="performSearch()" class="btn-search">SEARCH</button>
        </div>
    </div>

    <div id="profileView" class="profile-view animate__animated animate__fadeInRight">
        <div id="missingAlert" class="missing-banner animate__animated animate__pulse animate__infinite">‚ö†Ô∏è MARKED MISSING!</div>
        <div class="profile-header">
            <button onclick="location.reload()" class="btn btn-sm btn-light rounded-circle position-absolute top-0 start-0 m-3"><i class="bi bi-arrow-left"></i></button>
            <div class="bg-white text-primary d-flex align-items-center justify-content-center mx-auto mb-3" style="width:70px; height:70px; border-radius:50%; font-weight:bold; font-size:1.8rem;" id="pAvatar">A</div>
            <h3 class="fw-bold mb-1" id="pName">...</h3>
            <span class="badge bg-white text-primary bg-opacity-25" id="pID">...</span>
            <div class="mt-3"><h5 class="fw-bold mb-0" id="pTroop">-</h5><small class="text-white-50">Troop</small></div>
        </div>
        <div class="timeline-box">
            <h6 class="fw-bold text-muted mb-4 text-uppercase">Activity Log</h6>
            <div id="timelineContainer"><p class="text-center text-muted">Loading...</p></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, query as rtdbQuery, orderByChild, equalTo, get, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // üî¥ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    window.performSearch = async function() {
        let val = document.getElementById('searchInput').value.trim();
        if(!val) return;
        Swal.showLoading();

        try {
            // Firestore Profile
            let docID = val.replace('/', '_'); 
            let snap = await getDoc(doc(db, "scouts", docID));
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db, "scouts"), where("id", "==", val)));
                if(q.empty) { Swal.fire('Not Found'); return; }
                snap = q.docs[0];
            }
            
            let s = snap.data();
            document.getElementById('searchView').style.display='none';
            document.getElementById('profileView').style.display='block';
            document.getElementById('pName').innerText = s.name;
            document.getElementById('pID').innerText = s.id;
            document.getElementById('pTroop').innerText = s.troop;
            document.getElementById('pAvatar').innerText = s.name.charAt(0);
            document.getElementById('missingAlert').style.display = s.isMissing ? 'block' : 'none';
            if(s.isMissing) document.querySelector('.profile-header').style.background = '#ff7675';

            // RTDB Logs
            const logsRef = rtdbQuery(ref(rtdb, 'logs'), orderByChild('scoutID'), equalTo(s.id));
            const lSnap = await get(logsRef);
            let h = "";
            if(lSnap.exists()) {
                let logs = Object.values(lSnap.val()).sort((a,b)=>b.timestamp-a.timestamp);
                logs.forEach(l => {
                    let c = l.action.includes('IN')?'#00b894':(l.action.includes('OUT')?'#d63031':'#6c5ce7');
                    h += `<div class="timeline-item"><div class="timeline-dot" style="background:${c}"></div><div class="t-time">${new Date(l.timestamp).toLocaleString()}</div><div class="t-event">${l.eventName}</div><span class="badge bg-light text-dark border">${l.action}</span></div>`;
                });
            } else h = "<p class='text-center text-muted'>No activity</p>";
            document.getElementById('timelineContainer').innerHTML = h;
            Swal.close();

        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>
