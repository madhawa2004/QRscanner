<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keboree Scanner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .screen.active { display: flex; }
        .header-text { text-align: center; color: #007bff; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 20px; margin-bottom: 20px; }
        .camera-box { background-color: #000; border-radius: 20px; width: 100%; aspect-ratio: 1/1; overflow: hidden; position: relative; margin-bottom: 20px; border: 4px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }
        .input-group-custom { background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .form-label { font-size: 0.8rem; font-weight: 700; color: #6c757d; margin-bottom: 5px; }
        .form-control, .form-select { border: 1px solid #e9ecef; border-radius: 10px; padding: 12px; font-weight: 600; font-size: 0.95rem; background: #f8f9fa; }
        .btn-scan { width: 100%; background-color: #007bff; color: white; border: none; padding: 18px; font-size: 1.1rem; font-weight: 700; border-radius: 15px; letter-spacing: 1px; margin-top: auto; z-index: 10; }
        .btn-scan.stop { background-color: #dc3545; }
        .avatar-circle { width: 100px; height: 100px; background: #e2e8f0; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: #64748b; border: 4px solid #fff; }
        .btn-action { width: 100%; padding: 16px; border-radius: 50px; font-weight: 700; font-size: 1rem; border: none; background: #fff; color: #333; margin-bottom: 10px; transition: 0.2s; }
        .btn-action.primary { background: #007bff; color: white; }
        #screen-missing { background-color: #ef4444; color: white; text-align: center; justify-content: center; }
        .btn-dismiss { background: white; color: #ef4444; width: 100%; border-radius: 50px; padding: 15px; font-weight: 800; border: none; margin-top: auto; }
        #screen-broadcast { background-color: #ffc107; color: #212529; text-align: center; justify-content: center; }
        .broadcast-card { background: white; padding: 25px; border-radius: 20px; text-align: left; }
        .btn-ack { background: #212529; color: white; width: 100%; border-radius: 50px; padding: 15px; font-weight: 700; border: none; margin-top: auto; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div class="header-text">Keboree Scanner</div>
        <div class="camera-box"><div id="reader"></div><i class="bi bi-camera-fill display-1 text-muted" id="camIcon" style="position:absolute;"></i></div>
        <div class="input-group-custom">
            <div class="mb-3"><label class="form-label">Select Camera</label><select id="cameraSelect" class="form-select"><option value="">Auto Detect</option></select></div>
            <div class="mb-3"><label class="form-label">Event</label><select id="eventSelect" class="form-select"><option value="">Loading...</option></select></div>
            <div><label class="form-label">Manual ID</label><input type="text" id="manualInput" class="form-control" placeholder="Enter ID Manually"></div>
        </div>
        <button id="scanBtn" class="btn-scan" onclick="handleScanToggle()">SCAN</button>
        <div class="text-center mt-2"><a href="#" onclick="logout()" class="text-muted small">Logout</a></div>
    </div>

    <div id="screen-details" class="screen">
        <div class="d-flex align-items-center mb-3"><button class="btn border-0 bg-transparent fs-4" onclick="goHome()"><i class="bi bi-arrow-left"></i></button><h5 class="ms-2 mb-0 fw-bold">Scout Details</h5></div>
        <div class="text-center mb-4"><div class="avatar-circle" id="dAvatar">A</div><h2 class="fw-bold" id="dName">Name</h2><p class="text-muted"><span id="dID">ID</span> â€¢ <span id="dTroop">Troop</span></p></div>
        <h6 class="text-muted small fw-bold mb-3 text-uppercase">Actions</h6>
        <div id="actionContainer" class="d-flex flex-column"></div>
        <button class="btn btn-link text-muted mt-3 fw-bold" onclick="goHome()">Cancel</button>
    </div>

    <div id="screen-missing" class="screen">
        <i class="bi bi-exclamation-triangle-fill display-1 mb-3"></i><h1 class="fw-bold">MISSING SCOUT<br>FOUND!</h1>
        <div class="my-4"><div class="bg-white rounded-circle d-flex align-items-center justify-content-center mx-auto text-danger display-3 fw-bold" style="width:100px;height:100px;" id="mAvatar">A</div><h2 class="mt-3 fw-bold" id="mName">Name</h2><p class="opacity-75" id="mDetails">Details</p></div>
        <button class="btn-dismiss" onclick="goHome()">Dismiss Alert</button>
    </div>

    <div id="screen-broadcast" class="screen">
        <div class="d-flex align-items-center justify-content-center mb-4"><i class="bi bi-megaphone-fill fs-1 me-2"></i><h4 class="fw-bold mb-0 text-uppercase">Broadcast</h4></div>
        <div class="broadcast-card animate__animated animate__bounceIn"><h5 class="fw-bold mb-2">Message</h5><p id="broadcastMsg" class="lead">--</p><small class="text-muted" id="broadcastTime">Just now</small></div>
        <button class="btn-ack" onclick="goHome()">Acknowledge</button>
    </div>

    <audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ðŸ”´ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    let html5QrCode, selectedEvent, isCameraActive = false, currentScout = null;

    onAuthStateChanged(auth, u => { if(!u) window.location.href="index.html"; else { loadEvents(); populateCameras(); listenBroadcast(); } });

    window.showScreen = id => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    window.goHome = () => { window.showScreen('screen-home'); if(isCameraActive) stopCamera(); }

    function loadEvents() {
        onSnapshot(collection(db, "events"), snap => {
            const sel = document.getElementById('eventSelect'); sel.innerHTML='<option value="">Select Event</option>';
            snap.forEach(d => { if(d.data().active) {
                let opt=document.createElement('option'); opt.value=d.id; opt.text=d.data().name; opt.dataset.actions=JSON.stringify(d.data().actions||[]); sel.appendChild(opt);
            }});
        });
        document.getElementById('eventSelect').addEventListener('change', e => {
            let opt = e.target.options[e.target.selectedIndex];
            selectedEvent = e.target.value ? {id:e.target.value, name:opt.text, actions:JSON.parse(opt.dataset.actions)} : null;
        });
    }

    async function populateCameras() {
        try { const devs = await Html5Qrcode.getCameras(); const sel = document.getElementById('cameraSelect'); sel.innerHTML="";
        if(devs.length){ devs.forEach(d=>{let o=document.createElement('option');o.value=d.id;o.text=d.label;sel.appendChild(o)}); sel.value=devs[devs.length-1].id; }
        } catch(e){}
    }

    window.handleScanToggle = () => {
        let man = document.getElementById('manualInput').value.trim();
        if(man) { processScoutID(man); return; }
        if(!selectedEvent) { Swal.fire('Select Event', '', 'warning'); return; }
        if(isCameraActive) stopCamera(); else startCamera();
    }

    function startCamera() {
        const camId = document.getElementById('cameraSelect').value;
        html5QrCode = new Html5Qrcode("reader");
        document.getElementById('camIcon').style.display = 'none';
        html5QrCode.start(camId?{deviceId:{exact:camId}}:{facingMode:"environment"}, {fps:15, qrbox:{width:250,height:250}}, 
        (txt)=>{ document.getElementById('beep').play().catch(()=>{}); if(navigator.vibrate)navigator.vibrate(200); stopCamera(); processScoutID(txt); }, 
        (err)=>{});
        isCameraActive=true; document.getElementById('scanBtn').innerText="STOP CAMERA"; document.getElementById('scanBtn').classList.add('stop');
    }

    function stopCamera() {
        if(html5QrCode) html5QrCode.stop().then(()=>{ html5QrCode.clear(); isCameraActive=false; document.getElementById('camIcon').style.display='block'; document.getElementById('scanBtn').innerText="SCAN"; document.getElementById('scanBtn').classList.remove('stop'); }).catch(e=>{});
    }

    async function processScoutID(idText) {
        Swal.showLoading();
        try {
            let docID = idText.replace('/','_');
            let snap = await getDoc(doc(db,"scouts",docID));
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db,"scouts"), where("id","==",idText)));
                if(q.empty) throw new Error("ID Not Found");
                snap = q.docs[0];
            }
            Swal.close();
            currentScout = snap.data();

            if(currentScout.isMissing) {
                document.getElementById('mAvatar').innerText = currentScout.name.charAt(0);
                document.getElementById('mName').innerText = currentScout.name;
                document.getElementById('mDetails').innerText = currentScout.troop;
                window.showScreen('screen-missing');
            } else {
                document.getElementById('dName').innerText = currentScout.name;
                document.getElementById('dID').innerText = currentScout.id;
                document.getElementById('dTroop').innerText = currentScout.troop;
                document.getElementById('dAvatar').innerText = currentScout.name.charAt(0);
                let con = document.getElementById('actionContainer'); con.innerHTML="";
                let acts = selectedEvent.actions.length ? selectedEvent.actions : ['Mark Present'];
                acts.forEach((a,i) => {
                    con.innerHTML += `<button onclick="submitLog('${a}')" class="btn-action ${i===0?'primary':''}">${a}</button>`;
                });
                window.showScreen('screen-details');
            }
        } catch(e) { Swal.fire('Error', e.message, 'error'); }
    }

    window.submitLog = (action) => {
        Swal.showLoading();
        push(ref(rtdb, 'logs'), {
            scoutID: currentScout.id, scoutName: currentScout.name,
            eventID: selectedEvent.id, eventName: selectedEvent.name,
            action: action, scannedBy: auth.currentUser.email, timestamp: serverTimestamp()
        }).then(() => {
            Swal.close(); Swal.fire({icon:'success', title:'Saved', timer:1000, showConfirmButton:false});
            document.getElementById('manualInput').value=""; goHome();
        }).catch(e => Swal.fire('Error', e.message, 'error'));
    }

    function listenBroadcast() {
        onValue(ref(rtdb, 'system/broadcast'), s => {
            let d = s.val();
            if(d && d.message) {
                let sent = new Date(d.timestamp);
                let now = new Date();
                let diff = (now - sent) / 1000 / 60;
                if(diff < 30) {
                    document.getElementById('broadcastMsg').innerText = d.message;
                    document.getElementById('broadcastTime').innerText = "Sent: " + sent.toLocaleTimeString();
                    window.showScreen('screen-broadcast');
                }
            }
        });
    }

    window.logout = () => signOut(auth).then(()=>window.location.href="index.html");
    
    window.handleScanToggle = handleScanToggle;
    window.goHome = goHome;
    window.submitLog = submitLog;
</script>
</body>
</html>
