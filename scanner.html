<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { margin:0; background:#000; font-family:'Poppins',sans-serif; height:100vh; overflow:hidden; color:#fff; display:flex; flex-direction:column; }
        #reader { width:100%; height:100%; object-fit:cover; position:absolute; z-index:1; }
        
        /* UI Layer */
        .ui-layer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; display:flex; flex-direction:column; justify-content:space-between; padding:20px; box-sizing:border-box; pointer-events:none; }
        .pointer-auto { pointer-events:auto; }
        
        /* Lock Screen */
        #lockScreen { position:absolute; top:0; left:0; width:100%; height:100%; background:#ef4444; z-index:2000; display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        
        /* Controls */
        .glass-bar { background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); padding:12px; border-radius:15px; display:flex; gap:10px; margin-bottom:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
        select, input { background:transparent; border:none; width:100%; outline:none; font-weight:600; font-size:1rem; color:#333; }
        
        .scan-box { flex-grow:1; display:flex; align-items:center; justify-content:center; position:relative; }
        .frame { width:260px; height:260px; border:4px solid #fff; border-radius:30px; box-shadow:0 0 0 1000px rgba(0,0,0,0.6); position:relative; }
        
        .bottom-controls { display:flex; justify-content:center; gap:25px; align-items:center; padding-bottom:30px; }
        .btn-circle { width:60px; height:60px; border-radius:50%; border:none; background:rgba(255,255,255,0.2); color:#fff; font-size:1.5rem; display:flex; align-items:center; justify-content:center; }
        .btn-scan { width:75px; height:75px; background:#0d6efd; border:4px solid rgba(255,255,255,0.3); box-shadow:0 0 20px rgba(13,110,253,0.5); font-size:2rem; }
        .btn-scan.stop { background:#dc3545; box-shadow:0 0 20px rgba(220,53,69,0.5); }

        /* Popup */
        .swal2-popup { border-radius:20px !important; background:#1f1f1f !important; color:#fff !important; }
        .btn-action { width:100%; padding:15px; border-radius:12px; border:none; margin:5px 0; font-weight:bold; }
        .btn-in{background:#00b894;color:#fff} .btn-out{background:#ff7675;color:#fff} .btn-other{background:#0984e3;color:#fff}
    </style>
</head>
<body>

<div id="lockScreen">
    <i class="bi bi-lock-fill" style="font-size: 5rem; color: white;"></i>
    <h1 style="font-weight: 800; margin-top: 20px;">SYSTEM LOCKED</h1>
    <p>Administrator has paused scanning.</p>
</div>

<div id="reader"></div>

<div class="ui-layer">
    <div class="pointer-auto">
        <div class="glass-bar"><i class="bi bi-camera-video text-muted"></i><select id="camSelect"><option>Auto Camera</option></select></div>
        <div class="glass-bar"><i class="bi bi-calendar-event text-primary"></i><select id="evtSelect"><option>Loading...</option></select></div>
        <div class="glass-bar"><i class="bi bi-keyboard text-success"></i><input id="manualInput" placeholder="Manual ID"><button onclick="manualScan()" style="border:none;background:none;"><i class="bi bi-arrow-right-circle-fill text-success fs-4"></i></button></div>
    </div>
    
    <div class="scan-box">
        <div class="frame" id="scanFrame"></div>
        <div id="loadingText" style="position:absolute; top:65%; font-size:0.8rem; color:#aaa;">READY</div>
    </div>

    <div class="bottom-controls pointer-auto">
        <button class="btn-circle" onclick="toggleFlash()" id="btnFlash"><i class="bi bi-lightning-fill"></i></button>
        <button class="btn-circle btn-scan" id="scanBtn" onclick="toggleScan()"><i class="bi bi-qr-code-scan"></i></button>
        <button class="btn-circle" style="background:rgba(255,0,0,0.3)" onclick="logout()"><i class="bi bi-power"></i></button>
    </div>
</div>

<audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, push, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    let html5QrCode, selectedEvent, isScanning=false, flash=false, isLocked=false, currentScout=null;

    onAuthStateChanged(auth, u => { if(!u) window.location.href="index.html"; else { initApp(); } });

    function initApp() {
        loadEvents(); initCam(); listenLock();
    }

    // üî• LOCK LISTENER
    function listenLock() {
        onValue(ref(rtdb, 'system/status/locked'), s => {
            isLocked = s.val() || false;
            const screen = document.getElementById('lockScreen');
            if(isLocked) {
                screen.style.display = 'flex';
                if(isScanning) stopCam(); // Force stop if locked
            } else {
                screen.style.display = 'none';
            }
        });
    }

    // --- EVENTS ---
    function loadEvents() {
        onSnapshot(collection(db,"events"), s=>{
            let h='<option value="">Select Event</option>';
            s.forEach(d=>{ if(d.data().active) h+=`<option value="${d.id}" data-acts='${JSON.stringify(d.data().actions)}'>${d.data().name}</option>` });
            document.getElementById('evtSelect').innerHTML=h;
        });
        document.getElementById('evtSelect').addEventListener('change', e=>{
            let o=e.target.options[e.target.selectedIndex];
            selectedEvent=e.target.value?{id:e.target.value,name:o.text,actions:JSON.parse(o.dataset.acts)}:null;
        });
    }

    // --- CAMERA ---
    async function initCam() {
        try { const d=await Html5Qrcode.getCameras(); let h=""; d.forEach(x=>h+=`<option value="${x.id}">${x.label}</option>`); 
        document.getElementById('camSelect').innerHTML=h; document.getElementById('camSelect').value=d[d.length-1].id; } catch(e){}
    }

    window.toggleScan = () => {
        if(isLocked) return;
        if(!selectedEvent) { Swal.fire({icon:'warning',title:'Select Event',toast:true,position:'top',timer:2000,showConfirmButton:false}); return; }
        if(isScanning) stopCam(); else startCam();
    }

    function startCam() {
        let id = document.getElementById('camSelect').value;
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(id, {fps:15, qrbox:{width:250,height:250}}, onScan, ()=>{});
        isScanning=true; 
        document.getElementById('scanBtn').classList.add('stop');
        document.getElementById('scanBtn').innerHTML='<i class="bi bi-stop-fill"></i>';
        document.getElementById('loadingText').style.display='none';
    }

    function stopCam() {
        if(html5QrCode) html5QrCode.stop().then(()=>{ html5QrCode.clear(); isScanning=false; 
            document.getElementById('scanBtn').classList.remove('stop');
            document.getElementById('scanBtn').innerHTML='<i class="bi bi-qr-code-scan"></i>';
            document.getElementById('loadingText').style.display='block';
        }).catch(()=>{});
    }

    window.toggleFlash = () => {
        if(html5QrCode && isScanning) { flash=!flash; html5QrCode.applyVideoConstraints({advanced:[{torch:flash}]}); }
    }

    // --- PROCESSING ---
    window.manualScan = () => onScan(document.getElementById('manualInput').value);

    async function onScan(txt) {
        if(!txt) return;
        stopCam(); document.getElementById('beep').play().catch(()=>{}); navigator.vibrate(200);
        Swal.showLoading();
        
        try {
            let did = txt.replace('/','_');
            let snap = await getDoc(doc(db,"scouts",did));
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db,"scouts"), where("id","==",txt)));
                if(q.empty) throw new Error("ID Not Found");
                snap = q.docs[0];
            }
            currentScout = snap.data();
            showModal();
        } catch(e) { Swal.fire('Error', 'Invalid ID', 'error'); }
    }

    function showModal() {
        let s = currentScout;
        let btns = "";
        if(selectedEvent.actions.length) selectedEvent.actions.forEach(a => {
            let c = a.includes('IN')?'btn-in':(a.includes('OUT')?'btn-out':'btn-other');
            btns += `<button onclick="window.log('${a}')" class="btn-action ${c}">${a}</button>`;
        }); else btns = `<button onclick="window.log('Present')" class="btn-action btn-other">Mark Present</button>`;
        
        let alert = s.isMissing ? `<div class="bg-danger p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è MISSING SCOUT</div>` : '';

        Swal.fire({
            title: s.name,
            html: `${alert}<p style="color:#aaa">${s.id} ‚Ä¢ ${s.troop}</p>${btns}`,
            showConfirmButton: false, showCancelButton: true, cancelButtonText: 'Cancel',
            background: '#1f1f1f', color: '#fff'
        });
    }

    // üî• FIXED TIME LOGGING (Using Date.now())
    window.log = (act) => {
        Swal.showLoading();
        push(ref(rtdb, 'logs'), {
            scoutID: currentScout.id, scoutName: currentScout.name, scoutTroop: currentScout.troop,
            eventID: selectedEvent.id, eventName: selectedEvent.name,
            action: act, scannedBy: auth.currentUser.email,
            timestamp: Date.now() // ‚úÖ Sends Phone Time
        }).then(() => {
            if(currentScout.isMissing) push(ref(rtdb,'system/alerts'), {scoutName:currentScout.name, scanner:auth.currentUser.email, timestamp:Date.now()});
            Swal.close();
            const Toast = Swal.mixin({toast:true, position:'top', showConfirmButton:false, timer:1000, background:'#00b894', color:'#fff'});
            Toast.fire({icon:'success', title:'Saved'});
            document.getElementById('manualInput').value="";
            startCam(); // Auto restart
        });
    }

    window.logout = () => signOut(auth).then(()=>window.location.href="index.html");
    window.manualScan = manualScan; window.log = log; window.toggleFlash = toggleFlash; window.toggleScan = toggleScan;
</script>
</body>
</html>
