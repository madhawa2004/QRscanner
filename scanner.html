<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: #000; height: 100vh; overflow: hidden; display: flex; flex-direction: column; font-family: sans-serif; }
        #reader { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .ui { position: absolute; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; pointer-events: none; }
        .pointer { pointer-events: auto; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 10px; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 10px; display: flex; align-items: center; }
        select, input { background: transparent; border: none; color: white; width: 100%; outline: none; font-weight: bold; }
        option { background: #000; }
        .scan-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .frame { width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.5); border-radius: 20px; position: relative; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.6); }
        .btn-scan { width: 80px; height: 80px; background: #0d6efd; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); color: white; font-size: 2rem; display: flex; align-items: center; justify-content: center; }
        .btn-scan.stop { background: #dc3545; }
        .btn-sm-c { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; border: none; color: white; font-size: 1.2rem; }
        
        #locked { position: absolute; width: 100%; height: 100%; background: #ef4444; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; }
        #broadcast { position: absolute; width: 100%; height: 100%; background: #ffc107; z-index: 1500; display: none; flex-direction: column; justify-content: center; align-items: center; color: #000; padding: 20px; text-align: center; }
        
        .swal2-popup { background: #222 !important; color: #fff !important; border-radius: 20px !important; }
        .btn-act { width: 100%; padding: 15px; margin: 5px 0; border-radius: 10px; border: none; font-weight: bold; text-transform: uppercase; }
        .c-in { background: #10b981; color: white; } .c-out { background: #ef4444; color: white; } .c-other { background: #3b82f6; color: white; }
    </style>
</head>
<body>

<div id="locked"><i class="bi bi-lock-fill display-1"></i><h2 class="fw-bold mt-3">SYSTEM LOCKED</h2></div>
<div id="broadcast"><i class="bi bi-megaphone-fill display-1"></i><h3 class="fw-bold mt-3">ANNOUNCEMENT</h3><p class="lead fw-bold" id="bMsg">...</p><button class="btn btn-dark rounded-pill px-5 mt-4" onclick="hideBroadcast()">OK</button></div>

<div id="reader"></div>

<div class="ui">
    <div class="pointer">
        <div class="glass"><i class="bi bi-camera-video me-2 text-muted"></i><select id="camSelect"><option>Auto</option></select></div>
        <div class="glass"><i class="bi bi-calendar-event me-2 text-primary"></i><select id="evtSelect"><option>Loading...</option></select></div>
        <div class="glass"><i class="bi bi-keyboard me-2 text-success"></i><input id="manId" placeholder="Enter ID"><button onclick="manual()" class="btn btn-sm text-success fw-bold">GO</button></div>
    </div>

    <div class="scan-area"><div class="frame" id="frame"></div><div id="stat" style="position:absolute; top:65%; color:#aaa; font-size:0.8rem;">READY</div></div>

    <div class="d-flex justify-content-center gap-4 align-items-center pointer pb-4">
        <button class="btn-sm-c" onclick="flash()"><i class="bi bi-lightning-fill"></i></button>
        <button class="btn-scan" id="btnScan" onclick="toggle()"><i class="bi bi-qr-code-scan"></i></button>
        <button class="btn-sm-c bg-danger" onclick="logout()"><i class="bi bi-power"></i></button>
    </div>
</div>

<audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, onSnapshot, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ CONFIG
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID",
        databaseURL: "https://YOUR_DB_URL.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    let html5QrCode, selectedEvent, isScanning=false, isLocked=false, currentScout=null;

    onAuthStateChanged(auth, u => {
        if(!u) window.location.href="index.html";
        else {
            loadEvents(); initCam();
            
            // üî• LOCK LISTENER
            onValue(ref(rtdb, 'system/status/locked'), s => {
                isLocked = s.val() || false;
                document.getElementById('locked').style.display = isLocked ? 'flex' : 'none';
                if(isLocked && isScanning) stop();
            });

            // üî• BROADCAST (60 Sec Rule)
            onValue(ref(rtdb, 'system/broadcast'), s => {
                let d = s.val();
                if(d && d.message) {
                    let diff = (Date.now() - d.timestamp)/1000;
                    if(diff < 60) {
                        document.getElementById('bMsg').innerText = d.message;
                        document.getElementById('broadcast').style.display = 'flex';
                        document.getElementById('beep').play().catch(()=>{});
                    }
                }
            });
        }
    });

    function loadEvents() {
        onSnapshot(collection(db,"events"), s=>{
            let h='<option value="">Select Event</option>';
            s.forEach(d=>{ if(d.data().active) h+=`<option value="${d.id}" data-acts='${JSON.stringify(d.data().actions)}'>${d.data().name}</option>` });
            document.getElementById('evtSelect').innerHTML=h;
        });
        document.getElementById('evtSelect').addEventListener('change', e=>{
            let o=e.target.options[e.target.selectedIndex];
            selectedEvent=e.target.value?{id:e.target.value,name:o.text,actions:JSON.parse(o.dataset.acts)}:null;
        });
    }

    async function initCam() {
        try { const d=await Html5Qrcode.getCameras(); let h=""; d.forEach(x=>h+=`<option value="${x.id}">${x.label}</option>`); 
        document.getElementById('camSelect').innerHTML=h; document.getElementById('camSelect').value=d[d.length-1].id; } catch(e){}
    }

    window.toggle = () => {
        if(isLocked) return;
        if(!selectedEvent) { Swal.fire({icon:'warning', title:'Select Event', toast:true, position:'top'}); return; }
        if(isScanning) stop(); else start();
    }

    function start() {
        let id = document.getElementById('camSelect').value;
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(id, {fps:15, qrbox:{width:250,height:250}}, onScan, ()=>{});
        isScanning=true; 
        document.getElementById('scanBtn').classList.add('stop');
        document.getElementById('scanBtn').innerHTML='<i class="bi bi-stop-fill"></i>';
        document.getElementById('stat').style.display='none';
    }

    function stop() {
        if(html5QrCode) html5QrCode.stop().then(()=>{ html5QrCode.clear(); isScanning=false; 
            document.getElementById('scanBtn').classList.remove('stop');
            document.getElementById('scanBtn').innerHTML='<i class="bi bi-qr-code-scan"></i>';
            document.getElementById('stat').style.display='block';
        }).catch(()=>{});
    }

    window.manual = () => onScan(document.getElementById('manId').value);

    async function onScan(txt) {
        if(!txt) return;
        stop(); document.getElementById('beep').play().catch(()=>{}); navigator.vibrate(200);
        Swal.showLoading();
        
        try {
            let did = txt.replace('/','_');
            let snap = await getDoc(doc(db,"scouts",did));
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db,"scouts"), where("id","==",txt)));
                if(q.empty) throw new Error("Not Found");
                snap = q.docs[0];
            }
            currentScout = snap.data();
            showModal();
        } catch(e) { Swal.fire('Error', 'Invalid ID', 'error'); }
    }

    function showModal() {
        let s = currentScout;
        let btns = "";
        if(selectedEvent.actions.length) selectedEvent.actions.forEach(a => {
            let c = a.includes('IN')?'c-in':(a.includes('OUT')?'c-out':'c-other');
            btns += `<button onclick="window.log('${a}')" class="btn-act ${c}">${a}</button>`;
        }); else btns = `<button onclick="window.log('Present')" class="btn-act c-other">Mark</button>`;
        
        let alert = s.isMissing ? `<div class="bg-danger p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è MISSING SCOUT</div>` : '';

        Swal.fire({
            title: s.name,
            html: `${alert}<p style="color:#aaa">${s.id} ‚Ä¢ ${s.troop}</p>${btns}`,
            showConfirmButton: false, showCancelButton: true, cancelButtonText: 'Cancel',
            background: '#222', color: '#fff'
        });
    }

    // üî• FIXED TIME & ALERT
    window.log = (act) => {
        Swal.showLoading();
        push(ref(rtdb, 'logs'), {
            scoutID: currentScout.id, scoutName: currentScout.name, scoutTroop: currentScout.troop,
            eventID: selectedEvent.id, eventName: selectedEvent.name,
            action: act, scannedBy: auth.currentUser.email,
            timestamp: Date.now() // ‚úÖ Send Time
        }).then(() => {
            if(currentScout.isMissing) {
                push(ref(rtdb, 'system/alerts'), { scoutName:currentScout.name, scanner:auth.currentUser.email, timestamp:Date.now() });
                updateDoc(doc(db, "scouts", currentScout.docId), { isMissing: false });
            }
            Swal.close();
            Swal.fire({icon:'success', title:'Saved', toast:true, position:'top', timer:1000, showConfirmButton:false});
            document.getElementById('manId').value=""; start();
        });
    }

    window.hideBroadcast = () => document.getElementById('broadcast').style.display = 'none';
    window.logout = () => signOut(auth).then(()=>location.href='index.html');
    window.manual = manual; window.log = log; window.toggle = toggle; window.hideBroadcast = hideBroadcast;
</script>
</body>
</html>
