<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scout Scanner</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        /* --- CLEAN MINIMAL WHITE UI --- */
        body { 
            margin: 0; padding: 0; background-color: #f8f9fa; overflow: hidden; 
            font-family: 'Poppins', sans-serif; color: #333; 
            height: 100vh; display: flex; flex-direction: column;
        }

        /* Camera Feed */
        #reader { 
            width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; 
        }
        
        /* UI Overlay */
        .overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }

        /* Top Floating Bar */
        .top-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-top: 10px;
        }
        .event-select {
            background: transparent; border: none; color: #333; width: 100%; 
            font-weight: 600; font-size: 0.95rem; outline: none;
        }

        /* Scan Frame (Minimal) */
        .scan-area {
            flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative;
        }
        .scan-frame {
            width: 260px; height: 260px; 
            border-radius: 35px;
            box-shadow: 0 0 0 1000px rgba(255, 255, 255, 0.85); /* White Mask */
            position: relative;
            border: 3px solid #ffffff;
        }
        /* Corner Accents */
        .scan-frame::after {
            content: ''; position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px;
            border: 2px dashed rgba(0,0,0,0.1); border-radius: 25px;
        }
        
        /* Pulse Animation */
        .scanning-pulse {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100px; height: 100px; background: rgba(108, 92, 231, 0.1);
            border-radius: 50%; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {transform:translate(-50%,-50%) scale(0.8); opacity:0.5;} 100% {transform:translate(-50%,-50%) scale(2.5); opacity:0;} }

        /* Success Animation */
        .success-border { border-color: #00b894 !important; transition: 0.3s; }

        /* Bottom Controls */
        .bottom-controls {
            display: flex; justify-content: center; gap: 30px; align-items: center; padding-bottom: 20px;
        }
        .control-btn {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            background: #fff; color: #555; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .control-btn:active { transform: scale(0.9); }
        .btn-flash.active { color: #f1c40f; background: #fff9db; }
        .btn-logout { background: #fee2e2; color: #ef4444; }

        /* Popups */
        .swal2-popup { border-radius: 25px !important; padding: 20px !important; }
        .action-btn { 
            width: 100%; padding: 16px; margin: 8px 0; font-size: 1rem; font-weight: 600; 
            border-radius: 15px; border: none; letter-spacing: 0.5px; transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.98); }
        .btn-in { background: #d1fae5; color: #065f46; } /* Soft Green */
        .btn-out { background: #fee2e2; color: #991b1b; } /* Soft Red */
        .btn-other { background: #e0e7ff; color: #3730a3; } /* Soft Blue */
        
        .missing-badge { background: #ffeded; color: #ef4444; padding: 10px; border-radius: 12px; font-weight: 600; margin-bottom: 15px; border: 1px solid #fecaca; }
    </style>
</head>
<body>

<div id="reader"></div>

<div class="overlay-layer">
    
    <div class="top-bar">
        <i class="bi bi-calendar4-event text-primary"></i>
        <select id="eventSelector" class="event-select">
            <option value="">Loading...</option>
        </select>
        <div id="statusDot" style="width:8px; height:8px; background:#ccc; border-radius:50%;"></div>
    </div>

    <div class="scan-area">
        <div class="scan-frame" id="scanFrame">
            <div class="scanning-pulse"></div>
        </div>
        <div id="loadingText" class="position-absolute mt-5 text-muted small fw-bold">STARTING CAMERA...</div>
    </div>

    <div class="bottom-controls">
        <button class="control-btn btn-flash" onclick="toggleFlash()" id="btnFlash"><i class="bi bi-lightning-fill"></i></button>
        <button class="control-btn btn-logout" onclick="logout()" style="width:70px; height:70px; font-size:1.6rem;"><i class="bi bi-power"></i></button>
        <button class="control-btn" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
</div>

<audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDoc, doc, addDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ðŸ”´ YOUR CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let html5QrCode;
    let selectedEvent = null;
    let isScanning = true;
    let flashState = false;

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            document.getElementById('statusDot').style.background = "#10b981"; // Green Dot
            initScanner();
            loadEvents();
        }
    });

    // --- EVENTS ---
    function loadEvents() {
        onSnapshot(collection(db, "events"), (snap) => {
            const sel = document.getElementById('eventSelector');
            sel.innerHTML = '<option value="">-- SELECT EVENT --</option>';
            snap.forEach(d => {
                const e = d.data();
                if(e.active) {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.text = e.name;
                    opt.dataset.actions = JSON.stringify(e.actions || []);
                    sel.appendChild(opt);
                }
            });
        });

        document.getElementById('eventSelector').addEventListener('change', (e) => {
            const opt = e.target.options[e.target.selectedIndex];
            if(e.target.value) selectedEvent = { id:e.target.value, name:opt.text, actions:JSON.parse(opt.dataset.actions) };
            else selectedEvent = null;
        });
    }

    // --- CAMERA ---
    async function initScanner() {
        html5QrCode = new Html5Qrcode("reader");
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250, aspectRatio: window.innerHeight/window.innerWidth }, onScanSuccess, ()=>{});
            document.getElementById('loadingText').style.display = 'none';
        } catch (err) { Swal.fire({icon:'error', title:'Camera Error', text: err}); }
    }

    window.toggleFlash = function() {
        if(!html5QrCode) return;
        flashState = !flashState;
        html5QrCode.applyVideoConstraints({ advanced: [{ torch: flashState }] })
            .then(() => document.getElementById('btnFlash').classList.toggle('active'))
            .catch(() => { flashState=!flashState; Swal.fire({toast:true, position:'center', icon:'info', title:'No Flashlight', showConfirmButton:false, timer:1500}); });
    }

    // --- LOGIC ---
    async function onScanSuccess(decodedText) {
        if(!isScanning) return;
        
        if(!selectedEvent) {
            pauseScan();
            await Swal.fire({icon:'info', title:'Select Event', text:'Please choose an event first.', confirmButtonColor:'#333'});
            resumeScan();
            return;
        }

        pauseScan();
        playFeedback();

        try {
            // ID Matching (Replacing slash logic)
            let docID = decodedText.replace('/', '_');
            let docSnap = await getDoc(doc(db, "scouts", docID));
            
            if(!docSnap.exists()) {
                const q = query(collection(db, "scouts"), where("id", "==", decodedText));
                const querySnap = await getDocs(q);
                if(!querySnap.empty) docSnap = querySnap.docs[0];
            }

            if(docSnap && docSnap.exists()) showActionModal(docSnap.data());
            else throw new Error("ID not found");

        } catch (e) {
            await Swal.fire({icon:'error', title:'Invalid QR', text: decodedText, timer:1500, showConfirmButton:false});
            resumeScan();
        }
    }

    function showActionModal(scout) {
        let buttons = '';
        if(selectedEvent.actions.length > 0) {
            selectedEvent.actions.forEach(act => {
                let cls = act === 'IN' ? 'btn-in' : (act === 'OUT' ? 'btn-out' : 'btn-other');
                buttons += `<button onclick="window.submitLog('${act}')" class="action-btn ${cls}">${act}</button>`;
            });
        } else {
            buttons = `<button onclick="window.submitLog('Present')" class="action-btn btn-other">MARK PRESENT</button>`;
        }

        let alertHtml = scout.isMissing ? `<div class="missing-badge"><i class="bi bi-exclamation-triangle-fill me-2"></i>REPORTED MISSING</div>` : '';
        window.tempScout = scout;

        Swal.fire({
            title: `<span style="font-weight:700; color:#333;">${scout.name}</span>`,
            html: `
                ${alertHtml}
                <div style="color:#888; font-size:0.9rem; margin-bottom:15px;">${scout.id} â€¢ ${scout.troop}</div>
                ${buttons}
                <button onclick="window.cancelScan()" class="btn btn-link text-muted text-decoration-none mt-2">Cancel</button>
            `,
            showConfirmButton: false,
            allowOutsideClick: false,
            background: '#fff',
            customClass: { popup: 'rounded-4' }
        });
    }

    window.submitLog = async function(action) {
        Swal.showLoading();
        try {
            await addDoc(collection(db, "logs"), {
                scoutID: window.tempScout.id, scoutName: window.tempScout.name,
                eventID: selectedEvent.id, eventName: selectedEvent.name,
                action: action, scannedBy: auth.currentUser.email, timestamp: serverTimestamp()
            });
            Swal.close();
            const Toast = Swal.mixin({toast:true, position:'top', showConfirmButton:false, timer:1500, background:'#d1fae5', color:'#065f46'});
            Toast.fire({icon:'success', title:`${action} Recorded`});
            resumeScan();
        } catch(e) { Swal.fire('Error', e.message, 'error'); resumeScan(); }
    }

    window.cancelScan = () => { Swal.close(); resumeScan(); }

    function playFeedback() {
        document.getElementById("beep").play().catch(()=>{});
        if(navigator.vibrate) navigator.vibrate(50);
        document.getElementById('scanFrame').classList.add('success-border');
        setTimeout(() => document.getElementById('scanFrame').classList.remove('success-border'), 300);
    }

    function pauseScan() { isScanning = false; html5QrCode.pause(); }
    function resumeScan() { html5QrCode.resume(); setTimeout(() => isScanning = true, 500); }
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
</script>
</body>
</html>