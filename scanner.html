<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro v2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #000; font-family: 'Poppins', sans-serif; height: 100vh; overflow: hidden; color: white; }
        
        /* Camera Feed */
        #reader { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 1; background: #000; }
        
        /* UI Layer */
        .ui-layer { position: absolute; width: 100%; height: 100%; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none; }
        
        /* Interactive Elements (Enable Clicks) */
        .pointer-events-auto { pointer-events: auto; }

        /* Top Bar */
        .top-bar { background: rgba(0,0,0,0.7); padding: 12px; border-radius: 50px; backdrop-filter: blur(10px); display: flex; gap: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .event-select { background: transparent; border: none; color: white; width: 100%; font-weight: 600; outline: none; }
        .event-select option { background: #333; }

        /* Scanner Box */
        .scan-box { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .frame { width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.3); border-radius: 25px; position: relative; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); }
        .frame::after { content: ''; position: absolute; inset: 20px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 15px; }
        
        /* Loading/Error Text */
        .status-msg { position: absolute; top: 60%; width: 100%; text-align: center; color: rgba(255,255,255,0.7); font-size: 0.9rem; text-shadow: 0 2px 4px black; }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 20px; padding-bottom: 30px; }
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 1.5rem; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-circle:active { background: white; color: black; }
        .btn-start { background: #00b894; color: white; width: auto; padding: 0 30px; border-radius: 30px; font-weight: bold; font-size: 1rem; display: none; } /* Hidden by default */

        /* SweetAlert Dark */
        .swal2-popup { background: #1f1f1f !important; color: white !important; border-radius: 20px !important; }
        .action-btn { width: 100%; padding: 15px; margin: 5px 0; border-radius: 12px; border: none; font-weight: bold; text-transform: uppercase; }
        .btn-in { background: #00b894; color: white; }
        .btn-out { background: #ff7675; color: white; }
    </style>
</head>
<body>

<div id="reader"></div>

<div class="ui-layer">
    <div class="top-bar pointer-events-auto">
        <i class="bi bi-qr-code-scan text-warning ps-2"></i>
        <select id="eventSelect" class="event-select"><option value="">Loading Events...</option></select>
    </div>

    <div class="scan-box">
        <div class="frame"></div>
        <div id="statusText" class="status-msg">Initializing Camera...</div>
        <button id="btnStartManual" class="btn-circle btn-start pointer-events-auto" onclick="startCamera()">TAP TO START</button>
    </div>

    <div class="controls pointer-events-auto">
        <button class="btn-circle" onclick="toggleFlash()"><i class="bi bi-lightning-fill"></i></button>
        <button class="btn-circle" style="background:rgba(255,50,50,0.4)" onclick="logout()"><i class="bi bi-power"></i></button>
        <button class="btn-circle" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i></button>
    </div>
</div>

<audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, addDoc, serverTimestamp, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let html5QrCode;
    let selectedEvent = null;
    let isScanning = true;

    // AUTH CHECK
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            loadEvents();
            // Start Camera Automatically with Delay
            setTimeout(() => startCamera(), 1000);
        }
    });

    // EVENT LOADER
    function loadEvents() {
        onSnapshot(collection(db, "events"), (snap) => {
            const sel = document.getElementById('eventSelect');
            sel.innerHTML = '<option value="">-- SELECT EVENT --</option>';
            snap.forEach(d => {
                const e = d.data();
                if(e.active) {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.text = e.name;
                    opt.dataset.actions = JSON.stringify(e.actions || []);
                    sel.appendChild(opt);
                }
            });
        });
        document.getElementById('eventSelect').addEventListener('change', (e) => {
            const opt = e.target.options[e.target.selectedIndex];
            if(e.target.value) selectedEvent = { id:e.target.value, name:opt.text, actions:JSON.parse(opt.dataset.actions) };
            else selectedEvent = null;
        });
    }

    // --- üî• ROBUST CAMERA START LOGIC ---
    window.startCamera = async function() {
        document.getElementById('statusText').innerText = "Accessing Camera...";
        document.getElementById('btnStartManual').style.display = 'none';

        try {
            // 1. Get List of Cameras
            const devices = await Html5Qrcode.getCameras();
            
            if (devices && devices.length) {
                // 2. Try the Back Camera (usually the last one in the list)
                const cameraId = devices[devices.length - 1].id;
                
                html5QrCode = new Html5Qrcode("reader");
                
                await html5QrCode.start(
                    cameraId, // Use ID instead of 'environment'
                    { fps: 20, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    (err) => { /* Scanning... ignore frame errors */ }
                );
                
                document.getElementById('statusText').innerText = "Scanning Active";
                
            } else {
                throw new Error("No cameras found.");
            }

        } catch (err) {
            console.error("Cam Error", err);
            
            // FALLBACK: Try Generic 'environment' mode if ID method failed
            try {
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 20, qrbox: { width: 250, height: 250 } },
                    onScanSuccess, 
                    ()=>{}
                );
                document.getElementById('statusText').innerText = "Scanning Active (Fallback)";
                
            } catch (err2) {
                // If EVERYTHING fails
                document.getElementById('statusText').innerText = "Camera Failed";
                document.getElementById('btnStartManual').style.display = 'flex'; // Show button to retry
                
                Swal.fire({
                    icon: 'error',
                    title: 'Camera Access Failed',
                    text: 'Please allow camera permissions in your browser settings and try again. Error: ' + err2,
                    confirmButtonText: 'Retry'
                }).then(() => location.reload());
            }
        }
    }

    // --- SCAN SUCCESS ---
    async function onScanSuccess(decodedText) {
        if(!isScanning) return;
        
        if(!selectedEvent) {
            pauseScan();
            await Swal.fire({icon:'warning', title:'Choose Event', text:'Select an event first.', background:'#333', color:'#fff'});
            resumeScan();
            return;
        }

        pauseScan();
        document.getElementById('beep').play().catch(()=>{});
        if(navigator.vibrate) navigator.vibrate(200);

        try {
            // ID Matching Logic
            let docID = decodedText.replace('/', '_');
            let docSnap = await getDoc(doc(db, "scouts", docID));
            
            // Fallback Search
            if(!docSnap.exists()) {
                const q = query(collection(db, "scouts"), where("id", "==", decodedText));
                const qSnap = await getDocs(q);
                if(!qSnap.empty) docSnap = qSnap.docs[0];
            }

            if(docSnap && docSnap.exists()) showActionModal(docSnap.data());
            else throw new Error("ID Not Found in DB");

        } catch (e) {
            await Swal.fire({icon:'error', title:'Error', text: e.message, timer:1500, showConfirmButton:false, background:'#333', color:'#fff'});
            resumeScan();
        }
    }

    function showActionModal(scout) {
        let btns = '';
        if(selectedEvent.actions && selectedEvent.actions.length > 0) {
            selectedEvent.actions.forEach(a => {
                let cls = a==='IN'?'btn-in':(a==='OUT'?'btn-out':'btn-light');
                btns += `<button onclick="window.submitLog('${a}')" class="action-btn ${cls}">${a}</button>`;
            });
        } else {
            btns = `<button onclick="window.submitLog('Present')" class="action-btn btn-light">MARK PRESENT</button>`;
        }

        let alert = scout.isMissing ? `<div class="bg-danger text-white p-2 rounded mb-2 text-center fw-bold">‚ö†Ô∏è MISSING SCOUT</div>` : '';
        window.tempScout = scout;

        Swal.fire({
            title: scout.name,
            html: `${alert}<p style="color:#aaa">${scout.id} | ${scout.troop}</p>${btns}<button onclick="window.cancelScan()" class="btn btn-link text-white mt-2">Cancel</button>`,
            showConfirmButton: false,
            background: '#1a1a1a',
            color: '#fff',
            allowOutsideClick: false
        });
    }

    window.submitLog = async function(action) {
        Swal.showLoading();
        try {
            await addDoc(collection(db, "logs"), {
                scoutID: window.tempScout.id, scoutName: window.tempScout.name,
                eventID: selectedEvent.id, eventName: selectedEvent.name,
                action: action, scannedBy: auth.currentUser.email, timestamp: serverTimestamp()
            });
            Swal.close();
            const Toast = Swal.mixin({toast:true, position:'top', showConfirmButton:false, timer:1000, background:'#00b894', color:'#fff'});
            Toast.fire({icon:'success', title: 'Saved'});
            resumeScan();
        } catch(e) { Swal.fire('Error', e.message); resumeScan(); }
    }

    function pauseScan() { isScanning = false; html5QrCode.pause(); }
    function resumeScan() { html5QrCode.resume(); setTimeout(() => isScanning = true, 500); }
    window.cancelScan = () => { Swal.close(); resumeScan(); }
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    
    // Flash
    window.toggleFlash = function() {
        if(html5QrCode) {
            html5QrCode.applyVideoConstraints({ advanced: [{ torch: true }] })
            .catch(() => Swal.fire({toast:true, icon:'info', title:'No Flashlight', position:'center', timer:1500, background:'#333', color:'#fff'}));
        }
    }
    
    // Attach Global
    window.startCamera = startCamera;
    window.submitLog = submitLog;
    window.cancelScan = window.cancelScan;
</script>
</body>
</html>
