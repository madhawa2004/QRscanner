<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background:#000; color:#fff; height:100vh; display:flex; flex-direction:column; }
        #reader { flex-grow:1; width:100%; object-fit:cover; }
        .controls { padding:20px; background:#111; text-align:center; }
        .btn-scan { width:80px; height:80px; border-radius:50%; font-size:2rem; border:4px solid white; background:red; color:white; }
        .btn-scan.active { background:green; }
        #locked { position:absolute; top:0; left:0; width:100%; height:100%; background:red; z-index:999; display:none; justify-content:center; align-items:center; font-size:2rem; font-weight:bold; }
        #broadcast { position:absolute; top:0; left:0; width:100%; height:100%; background:yellow; color:black; z-index:990; display:none; justify-content:center; align-items:center; padding:20px; text-align:center; }
    </style>
</head>
<body>

<div id="locked"><i class="bi bi-lock-fill"></i> LOCKED</div>
<div id="broadcast"><h3>ANNOUNCEMENT</h3><p id="bMsg" class="lead fw-bold">...</p><button class="btn btn-dark" onclick="this.parentElement.style.display='none'">OK</button></div>

<select id="eventSelect" class="form-select m-3 w-auto bg-dark text-white"><option value="">Select Event</option></select>
<div id="reader"></div>
<div class="controls">
    <input id="manual" class="form-control mb-2" placeholder="Manual ID">
    <button onclick="manualScan()" class="btn btn-secondary w-100 mb-3">Submit ID</button>
    <button id="camBtn" class="btn-scan active" onclick="toggleCam()"><i class="bi bi-camera-video"></i></button>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // üî¥ YOUR CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    let html5QrCode, selectedEvent, isScanning=false, currentScout;

    onAuthStateChanged(auth, u => { if(!u) location.href='index.html'; else init(); });

    function init() {
        onSnapshot(collection(db,"events"), s => {
            let h='<option value="">Select Event</option>';
            s.forEach(d => { if(d.data().active) h+=`<option value="${d.id}" data-acts='${JSON.stringify(d.data().actions)}'>${d.data().name}</option>` });
            document.getElementById('eventSelect').innerHTML=h;
        });
        document.getElementById('eventSelect').addEventListener('change', e => {
            let o = e.target.options[e.target.selectedIndex];
            selectedEvent = e.target.value ? {id:e.target.value, name:o.text, actions:JSON.parse(o.dataset.acts)} : null;
        });

        // Lock Listener
        onValue(ref(rtdb, 'system/status/locked'), s => {
            if(s.val()) { document.getElementById('locked').style.display='flex'; if(isScanning) stopCam(); }
            else document.getElementById('locked').style.display='none';
        });

        // Broadcast Listener
        onValue(ref(rtdb, 'system/broadcast'), s => {
            let d = s.val();
            if(d && (Date.now() - d.timestamp) < 120000) { // 2 Mins Expiry
                document.getElementById('bMsg').innerText = d.message;
                document.getElementById('broadcast').style.display = 'flex';
            }
        });
    }

    window.toggleCam = () => { if(isScanning) stopCam(); else startCam(); }

    function startCam() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan, ()=>{});
        isScanning = true;
        document.getElementById('camBtn').classList.remove('active');
    }
    function stopCam() {
        html5QrCode.stop().then(() => { html5QrCode.clear(); isScanning=false; document.getElementById('camBtn').classList.add('active'); });
    }

    window.manualScan = () => onScan(document.getElementById('manual').value);

    async function onScan(txt) {
        if(!selectedEvent) return Swal.fire('Select Event');
        stopCam();
        
        try {
            let did = txt.replace('/','_');
            let snap = await getDoc(doc(db,"scouts",did));
            
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db,"scouts"), where("id","==",txt)));
                if(q.empty) throw new Error('ID Not Found');
                snap = q.docs[0];
            }
            currentScout = snap.data();
            
            let btns = "";
            selectedEvent.actions.forEach(a => btns += `<button onclick="log('${a}')" class="btn btn-primary w-100 mb-2">${a}</button>`);
            
            let warning = currentScout.isMissing ? '<div class="alert alert-danger">‚ö†Ô∏è MISSING SCOUT!</div>' : '';
            
            Swal.fire({
                title: currentScout.name,
                html: `${warning}<p>${currentScout.id}</p>${btns}`,
                showConfirmButton: false
            });
        } catch(e) { Swal.fire('Error', 'ID Invalid', 'error'); }
    }

    window.log = (act) => {
        Swal.showLoading();
        push(ref(rtdb, 'logs'), {
            scoutID: currentScout.id, scoutName: currentScout.name, scoutTroop: currentScout.troop,
            eventID: selectedEvent.id, eventName: selectedEvent.name,
            action: act, scannedBy: auth.currentUser.email,
            timestamp: Date.now() // ‚úÖ FIX TIME
        }).then(() => {
            if(currentScout.isMissing) {
                push(ref(rtdb, 'system/alerts'), { scoutName:currentScout.name, scanner:auth.currentUser.email, timestamp:Date.now() });
                updateDoc(doc(db,"scouts",currentScout.docId), {isMissing:false});
            }
            Swal.close(); Swal.fire('Saved', '', 'success');
            document.getElementById('manual').value="";
        });
    }
</script>
</body>
</html>
