<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keboree Scanner</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        /* --- CLEAN MINIMAL THEME --- */
        body { 
            background-color: #f8f9fa; font-family: 'Poppins', sans-serif; 
            height: 100vh; overflow-y: auto; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }

        .header-text { 
            color: #0d6efd; font-weight: 700; text-transform: uppercase; 
            letter-spacing: 1px; margin-bottom: 20px; text-align: center; 
        }

        /* Camera Box (Fixed Size) */
        .camera-wrapper {
            width: 100%; max-width: 320px; aspect-ratio: 1/1;
            background-color: #000; border-radius: 30px;
            overflow: hidden; position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            border: 4px solid #fff; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        
        #reader { width: 100%; height: 100%; object-fit: cover; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 26px; }
        
        /* Placeholder Icon */
        .cam-placeholder { font-size: 4rem; color: #333; position: absolute; z-index: 0; }

        /* Input Area */
        .controls-card {
            background: #fff; padding: 25px; border-radius: 25px; width: 100%; max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .form-label { font-size: 0.85rem; font-weight: 600; color: #6c757d; margin-bottom: 5px; }
        .form-control, .form-select {
            border: 2px solid #f1f3f5; border-radius: 12px; padding: 12px; font-weight: 500; background: #f8f9fa;
        }
        .form-control:focus, .form-select:focus { border-color: #0d6efd; background: #fff; box-shadow: none; }

        /* Buttons */
        .btn-scan {
            width: 100%; max-width: 400px; background-color: #0d6efd; color: white; 
            border: none; padding: 16px; font-size: 1.1rem; font-weight: 700; 
            border-radius: 50px; box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3); transition: 0.2s;
        }
        .btn-scan:active { transform: scale(0.98); }
        .btn-scan.stop { background-color: #dc3545; box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3); }

        .btn-flash {
            position: absolute; top: 15px; right: 15px; z-index: 10;
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; backdrop-filter: blur(5px);
        }
        .btn-flash.active { color: #ffd700; background: rgba(255,255,255,0.4); }

        /* Popups & Modals */
        .swal2-popup { border-radius: 25px !important; padding: 20px !important; }
        .action-btn { width: 100%; padding: 15px; margin: 8px 0; border-radius: 15px; border: none; font-weight: 700; }
        .btn-in { background: #d1fae5; color: #065f46; }
        .btn-out { background: #fee2e2; color: #991b1b; }
        .btn-other { background: #e0e7ff; color: #3730a3; }
        
        /* Screen Management */
        .screen { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        
        /* Missing Alert */
        .missing-bg { background-color: #fee2e2; color: #991b1b; height: 100vh; justify-content: center; width: 100%; position: absolute; top:0; left:0; z-index: 2000;}
        .avatar-circle { width: 100px; height: 100px; background: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 15px; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h4 class="header-text">Keboree Scanner</h4>
        
        <div class="camera-wrapper">
            <button class="btn-flash" id="btnFlash" onclick="toggleFlash()"><i class="bi bi-lightning-fill"></i></button>
            <div id="reader"></div>
            <i class="bi bi-camera-fill cam-placeholder" id="camIcon"></i>
        </div>

        <div class="controls-card">
            <div class="mb-3">
                <label class="form-label">Select Camera</label>
                <select id="cameraSelect" class="form-select"><option value="">Auto Detect</option></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Event</label>
                <select id="eventSelect" class="form-select"><option value="">Loading...</option></select>
            </div>
            <div>
                <label class="form-label">Manual ID</label>
                <input type="text" id="manualInput" class="form-control" placeholder="Enter ID">
            </div>
        </div>

        <button id="scanBtn" class="btn-scan" onclick="handleScanToggle()">START SCANNER</button>
        
        <div class="mt-3">
            <button onclick="logout()" class="btn btn-sm text-muted"><i class="bi bi-box-arrow-left"></i> Logout</button>
            <button onclick="location.reload()" class="btn btn-sm text-muted"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>
    </div>

    <div id="screen-details" class="screen">
        <div class="w-100 mb-4"><button class="btn border-0" onclick="goHome()"><i class="bi bi-arrow-left fs-3"></i></button></div>
        <div class="text-center w-100">
            <div class="avatar-circle" id="dAvatar">A</div>
            <h2 class="fw-bold mb-0" id="dName">Name</h2>
            <p class="text-muted"><span id="dID">ID</span> â€¢ <span id="dTroop">Troop</span></p>
        </div>
        <div id="actionContainer" class="w-100 mt-3" style="max-width: 350px;"></div>
        <button class="btn btn-link text-muted mt-4 fw-bold" onclick="goHome()">Cancel</button>
    </div>

    <div id="screen-missing" class="screen missing-bg">
        <i class="bi bi-exclamation-octagon-fill display-1 mb-3 text-danger"></i>
        <h1 class="fw-bold text-danger">MISSING SCOUT!</h1>
        <div class="my-4 text-center">
            <h2 class="fw-bold" id="mName">Name</h2>
            <p class="fs-5" id="mDetails">Troop Details</p>
        </div>
        <button class="btn btn-light text-danger fw-bold rounded-pill px-5 py-3 shadow" onclick="goHome()">DISMISS ALERT</button>
    </div>

    <div id="screen-broadcast" class="screen" style="background:#fff3cd; position:absolute; top:0; left:0; height:100%; justify-content:center; z-index:3000;">
        <div class="card p-4 text-center shadow-lg border-0" style="max-width:350px;">
            <i class="bi bi-megaphone-fill text-warning display-4 mb-3"></i>
            <h4 class="fw-bold">ANNOUNCEMENT</h4>
            <p class="lead my-3" id="broadcastMsg">...</p>
            <small class="text-muted" id="broadcastTime">Just now</small>
            <button class="btn btn-dark rounded-pill mt-4 fw-bold" onclick="goHome()">OK, GOT IT</button>
        </div>
    </div>

    <audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, onSnapshot, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ðŸ”´ CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBsBsKnXv6FgYVk7OLo0XagFSBZgYajuNA",
        authDomain: "qr-system-02---web-based.firebaseapp.com",
        projectId: "qr-system-02---web-based",
        storageBucket: "qr-system-02---web-based.firebasestorage.app",
        messagingSenderId: "742559334366",
        appId: "1:742559334366:web:0c104f39997de0572fe74f",
        databaseURL: "https://qr-system-02---web-based-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const auth = getAuth(app);

    let html5QrCode, selectedEvent, isCameraActive = false, currentScout = null, flashState = false;

    onAuthStateChanged(auth, u => { 
        if(!u) window.location.href="index.html"; 
        else { loadEvents(); populateCameras(); listenBroadcast(); } 
    });

    window.showScreen = id => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    window.goHome = () => { window.showScreen('screen-home'); if(isCameraActive) stopCamera(); }

    function loadEvents() {
        onSnapshot(collection(db, "events"), snap => {
            const sel = document.getElementById('eventSelect'); sel.innerHTML='<option value="">Select Event</option>';
            snap.forEach(d => { if(d.data().active) {
                let opt=document.createElement('option'); opt.value=d.id; opt.text=d.data().name; opt.dataset.actions=JSON.stringify(d.data().actions||[]); sel.appendChild(opt);
            }});
        });
        document.getElementById('eventSelect').addEventListener('change', e => {
            let opt = e.target.options[e.target.selectedIndex];
            selectedEvent = e.target.value ? {id:e.target.value, name:opt.text, actions:JSON.parse(opt.dataset.actions)} : null;
        });
    }

    async function populateCameras() {
        try { const devs = await Html5Qrcode.getCameras(); const sel = document.getElementById('cameraSelect'); sel.innerHTML="";
        if(devs.length){ devs.forEach(d=>{let o=document.createElement('option');o.value=d.id;o.text=d.label;sel.appendChild(o)}); sel.value=devs[devs.length-1].id; }
        } catch(e){}
    }

    window.handleScanToggle = () => {
        let man = document.getElementById('manualInput').value.trim();
        if(man) { processScoutID(man); return; }
        if(!selectedEvent) { Swal.fire({icon:'warning', title:'Select Event', text:'Please select an event first.', confirmButtonColor:'#007bff'}); return; }
        if(isCameraActive) stopCamera(); else startCamera();
    }

    function startCamera() {
        const camId = document.getElementById('cameraSelect').value;
        html5QrCode = new Html5Qrcode("reader");
        document.getElementById('camIcon').style.display = 'none';
        
        // Clean Box Config
        const config = { fps: 15, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start(camId?{deviceId:{exact:camId}}:{facingMode:"environment"}, config, 
        (txt)=>{ document.getElementById('beep').play().catch(()=>{}); if(navigator.vibrate)navigator.vibrate(200); stopCamera(); processScoutID(txt); }, 
        (err)=>{});
        
        isCameraActive=true; 
        const btn = document.getElementById('scanBtn');
        btn.innerText = "STOP CAMERA"; btn.classList.add('stop');
    }

    function stopCamera() {
        if(html5QrCode) html5QrCode.stop().then(()=>{ 
            html5QrCode.clear(); isCameraActive=false; 
            document.getElementById('camIcon').style.display='block'; 
            const btn = document.getElementById('scanBtn');
            btn.innerText = "START SCANNER"; btn.classList.remove('stop'); 
        }).catch(e=>{});
    }

    // Flash Logic
    window.toggleFlash = function() {
        if(html5QrCode && isCameraActive) {
            flashState = !flashState;
            html5QrCode.applyVideoConstraints({ advanced: [{ torch: flashState }] })
            .then(() => {
                const btn = document.getElementById('btnFlash');
                if(flashState) btn.classList.add('active'); else btn.classList.remove('active');
            })
            .catch(() => Swal.fire({toast:true, icon:'info', title:'Flash not supported'}));
        }
    }

    async function processScoutID(idText) {
        Swal.showLoading();
        try {
            let docID = idText.replace('/','_');
            let snap = await getDoc(doc(db,"scouts",docID));
            if(!snap.exists()) {
                let q = await getDocs(query(collection(db,"scouts"), where("id","==",idText)));
                if(q.empty) throw new Error("ID Not Found");
                snap = q.docs[0];
            }
            Swal.close();
            currentScout = snap.data();

            if(currentScout.isMissing) {
                document.getElementById('mName').innerText = currentScout.name;
                document.getElementById('mDetails').innerText = currentScout.troop;
                window.showScreen('screen-missing');
            } else {
                document.getElementById('dName').innerText = currentScout.name;
                document.getElementById('dID').innerText = currentScout.id;
                document.getElementById('dTroop').innerText = currentScout.troop;
                document.getElementById('dAvatar').innerText = currentScout.name.charAt(0);
                
                let con = document.getElementById('actionContainer'); con.innerHTML="";
                let acts = selectedEvent.actions.length ? selectedEvent.actions : ['Mark Present'];
                acts.forEach((a,i) => {
                    let cls = a==='IN'?'btn-in':(a==='OUT'?'btn-out':'btn-other');
                    con.innerHTML += `<button onclick="submitLog('${a}')" class="btn-action ${cls}">${a}</button>`;
                });
                window.showScreen('screen-details');
            }
        } catch(e) { Swal.fire('Error', e.message, 'error'); }
    }

    window.submitLog = (action) => {
        Swal.showLoading();
        push(ref(rtdb, 'logs'), {
            scoutID: currentScout.id, scoutName: currentScout.name,
            eventID: selectedEvent.id, eventName: selectedEvent.name,
            action: action, scannedBy: auth.currentUser.email, timestamp: serverTimestamp()
        }).then(() => {
            Swal.close();
            Swal.fire({icon:'success', title:'Saved', timer:1000, showConfirmButton:false});
            document.getElementById('manualInput').value="";
            
            // If scout was missing, send found alert
            if(currentScout.isMissing) {
                push(ref(rtdb, 'system/alerts'), { scoutName: currentScout.name, scanner: auth.currentUser.email, timestamp: serverTimestamp() });
            }
            
            goHome();
        }).catch(e => Swal.fire('Error', e.message, 'error'));
    }

    function listenBroadcast() {
        onValue(ref(rtdb, 'system/broadcast'), s => {
            let d = s.val();
            if(d && d.message) {
                let diff = (new Date() - new Date(d.timestamp)) / 1000 / 60;
                if(diff < 30) {
                    document.getElementById('broadcastMsg').innerText = d.message;
                    document.getElementById('broadcastTime').innerText = "Sent: " + new Date(d.timestamp).toLocaleTimeString();
                    window.showScreen('screen-broadcast');
                }
            }
        });
    }

    window.logout = () => signOut(auth).then(()=>window.location.href="index.html");
    
    // Global
    window.handleScanToggle = handleScanToggle;
    window.goHome = goHome;
    window.submitLog = submitLog;
    window.toggleFlash = toggleFlash;
</script>
</body>
</html>
